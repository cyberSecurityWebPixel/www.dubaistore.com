var spotdyEventsConfigData = {};
var spotdyFlagForLoad = 1;
var otherSpotdyData;
var spotdyLoadEvents = [];
var urlToSendDataToServer = "https://events.cartup.ai/craftsvilla/events?type=clickstream&action=push&inputJson=";
var spotdyIpAddress = "https://api.ipify.org/";
var CARTUP_URL_TO_GET_CONFIG = "https://econsole.cartup.ai/SpotdyService?jobKey=conf&companyName=";
var urlToGetTheWidgetDataFromTheServer = "https://widgetapi.cartup.ai/v1/widgetserver/";
var CARTUP_PAGE_META_HOST = "https://ecomapi.cartup.ai";
var CARTUP_SIMILAR_SEARCH = "https://searchapi.cartup.ai/v1/search/similar";
//var CARTUP_URL_TO_GET_CONFIG = "https://estaging.cartup.ai/SpotdyService?jobKey=conf&companyName=";
//var urlToGetTheWidgetDataFromTheServer = "https://devwidgetapi.cartup.ai/v1/widgetserver/";
//var CARTUP_PAGE_META_HOST = "https://eapistage.cartup.ai";
var CARTUP_DOTS_URL = "https://ecomapi.cartup.ai/v1/find";
var setClosestData = false;
var recommenderStatus = true;
var badgingStatus = true;
var dotsStatus = true;
var searchStatus = true;
var plpStatus = true;

var allSpotdyWidgetData = {};

var cartUpPageType = "";

//on reload/refresh/url change
// window.navigation.addEventListener("navigate", (event) => {
//     console.log('location changed!');
//     SPOTDYLIBRARY.init(['9f630604-daa1-455d-aceb-a4150fa9127c']);
// })

// window.addEventListener("popstate", (event) => {
//     //if (window.history) {
//         // var myOldUrl = window.location.href;
//         // window.addEventListener('hashchange', function(){
//         //     window.history.pushState({}, null, myOldUrl);
//         // });
//         SPOTDYLIBRARY.init(['9f630604-daa1-455d-aceb-a4150fa9127c']);
//     //}
// })
// function checkURLchange(oldURL){
//     //if(window.location.href != oldURL){
//         //console.log("url changed!");
//         oldURL = window.location.href;
//         if(window.sessionStorage.orgId){
//             $.getScript("https://listener.cartup.ai/global/cartup_events.js");
//             SPOTDYLIBRARY.init([window.sessionStorage.orgId]);
//         }
//     //}
// }

//var oldURL = window.location.href;

// window.navigation.addEventListener("navigate", (event) => {
//     if(window.sessionStorage.orgId){
//         if(window.sessionStorage.orgId === "9f630604-daa1-455d-aceb-a4150fa9127c"){
//             if(document.querySelector('#cartup_events'))
//                 document.querySelector('#cartup_events').remove();
//             //setTimeout(function() {
//                 var js = {
//                     load: function (src, callback) {
//                         var script = document.createElement('script'), loaded;
//                         script.setAttribute('src', src);
//                         script.setAttribute('type', 'text/javascript');
//                         script.setAttribute('id', 'cartup_events');
//                         if (callback) {
//                             script.onreadystatechange = script.onload = function () {
//                                 if (!loaded) {
//                                     callback();
//                                 }
//                                 loaded = true;
//                             };
//                         }
//                         document.getElementsByTagName('body')[0].appendChild(script);
//                     }
//                 };
//                 js.load('https://listener.cartup.ai/global/cartup_events.js');
//                 SPOTDYLIBRARY.init([window.sessionStorage.orgId]);
//             //}, 1200);
//         }
//     }
// })

//end of reload/refresh/url change

if(!window.sessionStorage.sessionExpiry){
    window.sessionStorage.sessionExpiry = new Date(new Date().setMinutes(new Date().getMinutes() + 15));
}

setInterval(function() { 
    checkExpired()
}, 5000);

function checkExpired() {
    var exp = new Date(window.sessionStorage.sessionExpiry);
    if (exp < new Date()){
        sessionStorage.removeItem("cartupPageMeta"); 
        sessionStorage.removeItem("searchStatus"); 
        sessionStorage.removeItem("plpStatus"); 
        sessionStorage.removeItem("spotDyConfigData"); 
        sessionStorage.removeItem("otherSpotdyData"); 
        sessionStorage.removeItem("cartUpTemplates"); 
        sessionStorage.removeItem("cartupPageType");
        window.sessionStorage.sessionExpiry = new Date(new Date().setMinutes(new Date().getMinutes() + 15));
    }
}  

function getAllCartupTemplates(data) {
    let allWidgets = {};
    for (let key in data.widgetStatus) {
        if (data.widgetStatus[key].status) {
            allWidgets[key] = {};
        }
    }
    if(!window.sessionStorage.cartUpTemplates)
    getAllCartupWidgetTemplates(allWidgets);

    if(!window.sessionStorage.cartyTemplates)
    getAllCartyTemplates();
}

var GetCartupCssSelectorNode = function(parent, cssSelector) {
    if(!cssSelector) return;
    let arr = cssSelector.split(">");
    for(let index = 0; index < arr.length; index++) {
        if(arr[index].includes("{{.lastChild}}")){
            let elem = arr[index].replaceAll("{{.lastChild}}", "");
            let items = parent.querySelectorAll(elem);
            if(items.length > 0){
                let item = items[items.length-1];
                return item;
            }
            return null;
        }

        if(index == (arr.length - 1)){
            return parent.querySelector(arr[index]); 
        } else {
            parent = parent.querySelector(arr[index]); 
            if(!parent) return null;
        }
    }
}

var isUrlMatching = function(url) {
    return url && window.location.href.includes(url)
}

var cartUpMetas = [];

var IsCartupMetaMatching = function(metaInfo) {
    if(!metaInfo) return false;
    metaInfo = metaInfo.replaceAll("meta.", "").replaceAll("&amp;&amp;", "&&");
    let elem1 = metaInfo.split("&&")[0];
    let elem2 = metaInfo.split("&&")[1];
    if(cartUpMetas.length == 0 )
        cartUpMetas = document.getElementsByTagName("meta");
    
    for(let index = 0; index < cartUpMetas.length; index++){
        cartUpMeta = cartUpMetas[index];
        let key = elem1.split("=")[0];
        let value = elem1.split("=")[1];
        if (!value) continue;
        value = value.replaceAll('"', "");
        if(cartUpMeta.getAttribute(key) != value){
            continue;
        }
        if(elem2){
            let key = elem2.split("=")[0];
            let value = elem2.split("=")[1];
            value = value.replaceAll('"', "");
            if(cartUpMeta.getAttribute(key) != value){
                continue;
            }
        }
        return true;
    }
    return false;
}

var GetCartupPageType = function(config) {
    setTimeout(() => {
        for(var key in config) {
            let obj = config[key].pageMeta;
            let cssSelector = obj.cssSelector.info;
            let metaInfo = obj.metaInfo.info;
            if(GetCartupCssSelectorNode(document, cssSelector) || IsCartupMetaMatching(metaInfo) || isUrlMatching(obj.urlInfo.pageUrl)){
                cartUpPageType = key;
                window.sessionStorage.cartupPageType = key
                return;
            }
        }
    }, 300);
    

}

function spotdyGetXmlHttpObject()
{
    if (window.XMLHttpRequest){
        return new XMLHttpRequest();
    }
    if (window.ActiveXObject){
        return new ActiveXObject("Microsoft.XMLHTTP");
    }
    return null;
}

var SPOTDYLIBRARY = SPOTDYLIBRARY
    || (function () {
        var _args = {}; // private
        var convertInGivenFormat = function (data) {
            var widgetStatus = data.widgetStatus;
            if (widgetStatus.constructor == Array) {
                var length = widgetStatus.length;
                var status = {};
                for (var index = 0; index < length; index++) {
                    status[widgetStatus[index].name] = {
                        status: widgetStatus[index].status
                    };
                }
                data.widgetStatus = status;
            }
            return data;
        }
        var getSpotDyConfigData = function () {
            var ipData = window.sessionStorage.otherSpotdyData;
            if (!ipData) {
                var xhttp = spotdyGetXmlHttpObject();
                xhttp.onreadystatechange = function () {
                    if (xhttp.readyState == 4 && xhttp.status == 200) {
                        window.sessionStorage.ipAddress = xhttp.responseText.trim();
                    }
                };
                xhttp.open("GET", spotdyIpAddress, true);
                xhttp.send();
            } else
                otherSpotdyData = JSON.parse(ipData);
            try {
                if (window.sessionStorage.spotDyConfigData) {
                    var data = convertInGivenFormat(JSON.parse(window.sessionStorage.spotDyConfigData));
                    if(data.appInfo.cartup_recommender === false){
                        recommenderStatus = false;
                    }else{
                        recommenderStatus = true;
                    }
                    if(window.location.host === 'www.stg-ds.com')
                        recommenderStatus = true;

                    if(recommenderStatus === true){
                        if(data.showPreview){
                            setTimeout(function() {
                                cartUpPreview(data);
                            }, 1000);
                        }
                        getAllCartupTemplates(data);
                    }
                    spotdyGetAndSendData(data);
                } else {
                    makeAjaxCallToGetSpotdyConfigData();
                }
            } catch (err) {
                console.log(err);
            }
            try{
                if (!window.sessionStorage.cartupPageMeta) {
                    setTimeout(function(){
                        getcartupPageMeta();
                    },200)
                } else {
                    GetCartupPageType(JSON.parse(window.sessionStorage.cartupPageMeta));
                }
            } catch (err) {
                console.log(err);
            }
        };

        var getcartupPageMeta = function() {
        
            let obj = {
                "orgId": _args[0]
            }
            var url = CARTUP_PAGE_META_HOST + "/v1/config?request=" + encodeURI(JSON.stringify(obj));
            var xhttp = spotdyGetXmlHttpObject();
            xhttp.onreadystatechange = function () {
                if (xhttp.readyState == 4 && xhttp.status == 200) {
                    let obj = JSON.parse(xhttp.responseText.trim());
                    window.sessionStorage.cartupPageMeta = JSON.stringify(obj.pageMapping);
                    GetCartupPageType(obj.pageMapping);
                }
            };
            xhttp.open("GET", url, true);
            xhttp.send();
        }

        var makeAjaxCallToGetSpotdyConfigData = function () {
            var xhttp = spotdyGetXmlHttpObject();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    var data = this.responseText;
                    try {
                        data = JSON.parse(data);
                        if (!data || !data.companyConfig || data.responseCode != 0) {
                            return spotdyGetAndSendData(data);
                        }
                        data = JSON.parse(data.companyConfig);
                        data = convertInGivenFormat(data);
                        // if(data.orgId)
                        // window.sessionStorage.orgId = data.orgId;
                        // if(data.org)
                        // window.sessionStorage.orgName = data.org;
                        if(data.showPreview){
                            setTimeout(function() {
                                cartUpPreview(data);
                            }, 1000);
                        }
                        if(data.orgId == '9288b84f-54d8-4b74-88b4-9f8f9dbdc3df'){
                            var getDomain = window.location.hostname;
                            getDomain = getDomain.replace('www.','');
                            data.orgId = getDomain;
                            data.org = getDomain;
                        }
                        window.sessionStorage.spotDyConfigData = JSON.stringify(data);
                        
                        if(!data.appInfo){
                            data.appInfo = {
                                "cartup_recommender": true,
                                "cartup_badge" : true,
                                "cartup_dots" : true,
                                "cartup_search" : true,
                                "cartup_PLP" : true
                            };
                        }
                        
                        if(data.appInfo.cartup_recommender === false){
                            recommenderStatus = false;
                        }else{
                            recommenderStatus = true;
                        }
                        if(window.location.host === 'www.stg-ds.com')
                            recommenderStatus = true;
                        
                        // if(data.appInfo.cartup_search === false)
                        //     searchStatus = false;
                        
                        // if(data.appInfo.cartup_PLP === false)
                        //     plpStatus = false;

                        // window.sessionStorage.searchStatus = searchStatus;
                        // window.sessionStorage.plpStatus = plpStatus;
                        // if(searchStatus == true || plpStatus == true){
                        //     var imported = document.createElement('script');
                        //     imported.src = 'https://listener.cartup.ai/global/cartup_search.js';
                        //     imported.defer = true;
                        //     document.head.appendChild(imported);
                        // }
                        if(recommenderStatus === true)
                        getAllCartupTemplates(data);
                        spotdyGetAndSendData(data);
                    } catch (err) {
                        console.log(err);
                    }
                    return;
                }
                if (this.status >= 500) {
                    makeAjaxCallToGetSpotdyConfigData();
                }
            };
            xhttp.open("GET", CARTUP_URL_TO_GET_CONFIG + _args[0]);
            xhttp.send();
        };

        return {
            init: function (Args) {
                _args = Args;
                // let isCartupLoaded = window.sessionStorage.isCartupLoaded || "0";
                // if(isCartupLoaded == "0"){
                    getSpotDyConfigData();
                //     window.sessionStorage.isCartupLoaded = "1";
                //     setTimeout(function(){
                //         window.sessionStorage.isCartupLoaded = "0";
                //     }, 5000);
                // }
            }
        };
    }());

function spotdyGetAndSendData(data) {

    if (!data || (data == [])) {
        data = {
            "track":
                {
                    "onClick": true,
                    "onChange": true,
                    "onLoad": true
                },
            "org": "",
            "orgId": "",
            "frameWork": "",
            "events": {
                "onClick": [],
                "onChange": [],
                "onLoad": []
            },
            "widgetStatus": {}
        };
    }

    var initializeData = function () {
        return {
            "properties": {}
        };
    };
    spotdyEventsConfigData = data;
    var spotdySession = {
        "id": "",
        "expTime": ""
    };

    //check app status
    if(spotdyEventsConfigData.appInfo ){
        //let getAppStatus = spotdyEventsConfigData.subscription_info;
        let getAppEnableStatus = spotdyEventsConfigData.appInfo;

        if(getAppEnableStatus.cartup_recommender === true)
            recommenderStatus = true;
        else
            recommenderStatus = false; 

        if(window.location.host === 'www.stg-ds.com')
            recommenderStatus = true;
        
        if(getAppEnableStatus.cartup_badge === true)
            badgingStatus = true;
        else
            badgingStatus = false; 
        
        if(getAppEnableStatus.cartup_dots === true)
            dotsStatus = true;
        else
            dotsStatus = false;
        
        if(getAppEnableStatus.cartup_search === true)
            searchStatus = true;
        else
            searchStatus = false;
        
        if(getAppEnableStatus.cartup_PLP === true)
            plpStatus = true;
        else
            plpStatus = false;
        
    }
    
    var spotdySpecificLoadWidget = function () {
        window.sessionStorage.searchStatus = searchStatus;
        window.sessionStorage.plpStatus = plpStatus;
        // if(searchStatus == true || plpStatus == true){
        //     var imported = document.createElement('script');
        //     imported.src = 'https://listener.cartup.ai/global/cartup_search.js';
        //     imported.defer = true;
        //     document.head.appendChild(imported);
        // }
        if(recommenderStatus === true){
            cartupRetries(200, 15, () => {
                for (let key in spotdyEventsConfigData.widgetStatus) {
                    let widgetStatus = spotdyEventsConfigData.widgetStatus[key];
                    if (widgetStatus.status && !allSpotdyWidgetData[key]) {
                        let widgetElement = document.body;
                        // dom based
                        if(!cartUpPageType && window.sessionStorage.cartupPageMeta){
                            GetCartupPageType(JSON.parse(window.sessionStorage.cartupPageMeta))
                        }
                        if(cartUpPageType && widgetStatus?.domBased?.isDomBased && widgetStatus?.domBased?.pageMeta[cartUpPageType]){
                            let position = widgetStatus?.domBased?.pageMeta[cartUpPageType].pageMeta.metaInfo.position;
                            let cssSelector = widgetStatus?.domBased?.pageMeta[cartUpPageType].pageMeta.metaInfo.cssSelector;
                            widgetElement = GetCartupCssSelectorNode(document.body, cssSelector);
                            if (widgetElement) {
                                let success = functionToMakeAJAXCall(key, widgetStatus.requiredFields, spotdyEventsConfigData.productInfo);
                                if(success === true) {
                                    allSpotdyWidgetData[key] = {count: 0, element: widgetElement, position, isDomBased: true};
                                }
                                continue;
                            }
                        }

                        // division based
                        widgetElement = document.getElementById(key);
                        if(!widgetElement && widgetStatus.cssSelectorWidget){
                            widgetElement = GetCartupCssSelectorNode(document.body, widgetStatus.cssSelectorWidget);
                        }
                        
                        if (widgetElement) {
                            let success = functionToMakeAJAXCall(key, widgetStatus.requiredFields, spotdyEventsConfigData.productInfo);
                            if(success === true) {
                                allSpotdyWidgetData[key] = {count: 0, element: widgetElement};
                            }
                        }
                    }
                }
            });
        }
        setTimeout(function(){
            if(!cartUpPageType || cartUpPageType == '' || cartUpPageType == null)
            cartUpPageType = GetCartupPageType(JSON.parse(window.sessionStorage.cartupPageMeta))
            if(cartUpPageType){
                if(badgingStatus === true)
                // if(cartUpPageType === 'ProductPage' && window.sessionStorage.orgId !== '9f630604-daa1-455d-aceb-a4150fa9127c'){
                if(cartUpPageType === 'ProductPage'){
                    cartupBadgingApiCall(getCartupProductSku(),getCartupProductPName(), window.sessionStorage.orgId, spotdyEventsConfigData.org)
                }
                if(dotsStatus === true)
                   getDotsConfiguration(window.sessionStorage.orgId);
            }
        }, 1000);
    };

    var countProViewEvt = 0;
    var countCartViewEvt = 0;
    var countCategoryViewEvt = 0;
    
    var getAndSendDataToServer = (function () {
        var dataProvider = {}, spotdyData = {};
        var sendData = function () {
            var url = urlToSendDataToServer + encodeURIComponent(JSON.stringify(spotdyData))
                + "&type=clickstream.events";

            var xhttp = spotdyGetXmlHttpObject();
            xhttp.myurl = url;
            xhttp.onreadystatechange = function () {
                if (xhttp.readyState == 4 && xhttp.status == 200) {
                } else if (xhttp.readyState == 4) {
                    var requests = [];
                    if (!isEmpty(window.sessionStorage.pendingrequests)) {
                        requests = JSON.parse(window.sessionStorage.pendingrequests);
                    }
                    requests.push(xhttp.myurl);
                    window.sessionStorage.pendingrequests = JSON.stringify(requests);
                }
            };
            xhttp.open("GET", url, true);
            xhttp.send();
            dataProvider = "";
        };
        var addOrEliminateIrrelevantKeys = function () {
            for (var key in spotdyData.properties) {
                if (spotdyData.properties[key].value === undefined || spotdyData.properties[key].value === "" || spotdyData.properties[key].value === null)
                    delete spotdyData.properties[key];
            }
            if (window.localStorage.spotdyUserId) {
                spotdyData.properties['userid'] = {
                    "value": window.localStorage.spotdyUserId.toString(),
                    "type": "string"
                };
                // To pass it to the widget
                otherSpotdyData["userid"] = {"type": "string", "value": window.localStorage.spotdyUserId.toString()};
            }
        };
        var addSpecificKeysBasedOnEventType = function () {
            if (spotdyData.properties.eventType.value) {
                let eventType = spotdyData.properties.eventType.value.toLowerCase();
                // if (eventType == "view") {
                //     spotdyData.properties.eventType.value = "view";
                //     spotdyData.properties['spotdy_eventname'] = {
                //         "value": "__ecomtics_pageview",
                //         "type": "string"
                //     };
                // } else 
                if (eventType == "click") {
                    spotdyData.properties.eventType.value = "click";
                    spotdyData.properties['spotdy_eventname'] = {
                        "value": "__ecomtics_click",
                        "type": "string"
                    };
                } else if (["productview","product view"].includes(eventType)) {
                    spotdyData.properties.eventType.value = "productview";
                    spotdyData.properties['spotdy_eventname'] = {
                        "value": "__ecomtics_productview",
                        "type": "string"
                    };
                } 
                // else if (["pageview","page view"].includes(eventType)) {
                //     spotdyData.properties.eventType.value = "pageview";
                //     spotdyData.properties['spotdy_eventname'] = {
                //         "value": "__ecomtics_pageview",
                //         "type": "string"
                //     };
                // } 
                else if (["add to cart","addtocart"].includes(eventType)) {
                    spotdyData.properties.eventType.value = "addtocart";
                    spotdyData.properties['spotdy_eventname'] = {
                        "value": "__ecomtics_addtocart",
                        "type": "string"
                    };
                } else if (["signin","sign in"].includes(eventType)) {
                    spotdyData.properties.eventType.value = "signin";
                    spotdyData.properties['spotdy_eventname'] = {
                        "value": "__ecomtics_signin",
                        "type": "string"
                    };
                    if (spotdyData.properties.userid && spotdyData.properties.userid.value) {
                        window.localStorage.spotdyUserId = spotdyData.properties.userid.value;
                    }
                } else if (["addtowishlist","add to wishlist"].includes(eventType)) {
                    spotdyData.properties.eventType.value = "addtowishlist";
                    spotdyData.properties['spotdy_eventname'] = {
                        "value": "__ecomtics_wishlist",
                        "type": "string"
                    };
                } else if (eventType == "transaction") {
                    spotdyData.properties['spotdy_eventname'] = {
                        "value": "__ecomtics_transactions",
                        "type": "string"
                    };
                } else if (["checkout","check out"].includes(eventType)) {
                    spotdyData.properties.eventType.value = "checkout";
                    spotdyData.properties['spotdy_eventname'] = {
                        "value": "__ecomtics_checkout",
                        "type": "string"
                    };
                } else if (["login","log in"].includes(eventType)) {
                    spotdyData.properties.eventType.value = "login";
                    spotdyData.properties['spotdy_eventname'] = {
                        "value": "__ecomtics_login",
                        "type": "string"
                    };
                    if (spotdyData.properties.userid && spotdyData.properties.userid.value) {
                        window.localStorage.spotdyUserId = spotdyData.properties.userid.value;
                    }
                } else if (["signup","sign up"].includes(eventType)) {
                    spotdyData.properties.eventType.value = "signup";
                    spotdyData.properties['spotdy_eventname'] = {
                        "value": "__ecomtics_signup",
                        "type": "string"
                    };
                    if (spotdyData.properties.userid && spotdyData.properties.userid.value) {
                        window.localStorage.spotdyUserId = spotdyData.properties.userid.value;
                    }
                    if (spotdyData.properties.emailid && spotdyData.properties.emailid.value) {
                        window.localStorage.spotdyUserId = spotdyData.properties.emailid.value;
                    }
                } 
                // else if (eventType == "search") {
                //     spotdyData.properties['spotdy_eventname'] = {
                //         "value": "__ecomtics_search",
                //         "type": "string"
                //     };
                // } else if (eventType == "search view") {
                //     spotdyData.properties['spotdy_eventname'] = {
                //         "value": "__ecomtics_searchview",
                //         "type": "string"
                //     };
                // } 
                else if (eventType == "categoryview") {
                    spotdyData.properties['spotdy_eventname'] = {
                        "value": "__ecomtics_category_page_view",
                        "type": "string"
                    };
                } else if (["viewcart","cartview", "view cart", "cart view"].includes(eventType)) {
                    spotdyData.properties.eventType.value = "viewcart";
                    spotdyData.properties['spotdy_eventname'] = {
                        "value": "__ecomtics_cartview",
                        "type": "string"
                    };
                } else if (["rating and reviews","ratingandreviews"].includes(eventType)) {
                    spotdyData.properties.eventType.value = "ratingandreviews";
                    spotdyData.properties['spotdy_eventname'] = {
                        "value": "__spotdy_reviewratings",
                        "type": "string"
                    };
                } else if (["sign out","signout"].includes(eventType)) {
                    spotdyData.properties.eventType.value = "signout";
                    spotdyData.properties['spotdy_eventname'] = {
                        "value": "__ecomtics_signout",
                        "type": "string"
                    };
                    if (window.localStorage.spotdyUserId) {
                        delete window.localStorage.spotdyUserId;
                    }
                }
            }
        };
        var modifyDataBasedOnProperty = function () {
            for (var key in spotdyData.properties) {
                if (["subtotalamount", "price", "productprice", "totalamount", "total amount", "totalprice", "total price"].includes(key.toLowerCase())) {
                    var data = spotdyData.properties[key].value;
                    if(data){
                        if (data.constructor === Array) {
                            for (var index = 0; index < data.length; index++) {
                                data[index] = data[index].replace('ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã…Â¡Ãƒâ€šÃ‚Â¬ ', '').replace('ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã…Â¡Ãƒâ€šÃ‚Â¬', '').replace('$ ', '').replace('$', '').replace('ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â£', '').replace('Ãƒâ€šÃ‚Â£', '').replace('Ã‚Â£', '').replace('Ã¢â€šÂ¬','').replace('AED','').replace('AED ','');
                                if(data[index].includes(',') && data[index].includes('.')){
                                    data[index] = data[index].replace(',', '')
                                    if(parseFloat(data[index]) >=1000){
                                        data[index] = parseFloat(data[index])
                                    }
                                }else{
                                    data[index] = data[index].replace(',', '.')
                                }
                                data[index] = parseFloat(data[index])
                            
                            }
                            spotdyData.properties[key].value = data;
                            data = parseFloat(data);
                            spotdyData.properties[key].element_type = "double";

                        } else if (data.constructor === String) {
                            data = data.replace('ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã…Â¡Ãƒâ€šÃ‚Â¬ ', '').replace('ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã…Â¡Ãƒâ€šÃ‚Â¬', '').replace('$ ', '').replace('$', '').replace('ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â£', '').replace('Ãƒâ€šÃ‚Â£', '').replace('Ã‚Â£', '').replace('Ã¢â€šÂ¬','').replace('AED','').replace('AED ','');
                            if(data.includes(',') && data.includes('.')){
                                data = data.replace(',', '')
                                if(parseFloat(data) >=1000){
                                    data = parseFloat(data)
                                }
                            }else{
                                data = data.replace(',', '.')
                            }
                            data = parseFloat(data);
                            spotdyData.properties[key] = {"value": parseFloat(data), "type": "double"};
                        }
                    }
                } else if (key.toLowerCase() == "quantity") {
                    var data = spotdyData.properties[key].value;
                    if(data){
                        if (data.constructor === Array) {
                            for (var index = 0; index < data.length; index++) {
                                data[index] = data[index].replace('ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã…Â¡Ãƒâ€šÃ‚Â¬ ', '').replace('ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã…Â¡Ãƒâ€šÃ‚Â¬', '').replace('$ ', '').replace('$', '').replace('ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â£', '').replace('Ãƒâ€šÃ‚Â£', '').replace('Ã‚Â£', '').replace('Ã¢â€šÂ¬','').replace('AED','').replace('AED ','');
                                if(data[index].includes(',') && data[index].includes('.')){
                                    data[index] = data[index].replace(',', '')
                                    if(parseFloat(data[index]) >=1000){
                                        data[index] = parseFloat(data[index])
                                    }
                                }else{
                                    data[index] = data[index].replace(',', '.')
                                }
                                data[index] = parseFloat(data[index])
                            }
                            spotdyData.properties[key].value = data;
                            spotdyData.properties[key].type = "array";
                            spotdyData.properties[key].element_type = "long";
                        } else if (data.constructor === String) {
                            spotdyData.properties[key] = {"value": data, "type": "long"};
                        }
                    }
                } else if (key.toLowerCase() == "sku") {
                    if(spotdyData.properties[key].value && spotdyData.properties[key].value.includes("ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã…Â¡Ãƒâ€šÃ‚Â¬")){
                        spotdyData.properties[key].value = "";
                    }
                }
            }
        }

        return {
            begin: function (data, event) {
                spotdyData = JSON.parse(JSON.stringify(data));
                addEventProperties.addProperties(spotdyData, event);
            },
            addAndSendData: function (dP, data) {

                dataProvider = dP;
                spotdyData = functionToAddOtherData.addOtherData(data);
                if (dataProvider)
                    getProductData.getData(dataProvider, spotdyData);
                addSpecificKeysBasedOnEventType();
                modifyDataBasedOnProperty();
                addOrEliminateIrrelevantKeys();

                //product view
                if(spotdyData.properties.eventType.value === 'productview'){
                    countProViewEvt++;

                    if(countProViewEvt>1){
                        return true;
                    }
                }

                //cart view
                if(spotdyData.properties.eventType.value === 'viewcart'){
                    countCartViewEvt++;

                    if(countCartViewEvt>1){
                        return true;
                    }
                }

                //category view
                if(spotdyData.properties.eventType.value === 'categoryview'){
                    countCategoryViewEvt++;

                    if(countCategoryViewEvt>1){
                        return true;
                    }
                }

                sendData();
            }
        }
    })();

    function functionToExecuteAfterLoad(data) {
        window.sessionStorage.orgId = spotdyEventsConfigData.orgId;
        window.sessionStorage.orgName = spotdyEventsConfigData.org;
        if(spotdyEventsConfigData.frameWork == '')
        	spotdyEventsConfigData.frameWork = 'magento'
        window.sessionStorage.frameWork = spotdyEventsConfigData.frameWork;
        var getCartupUidEle = GetCartupCssSelectorNode(document, "meta[name='cartup_uid']");
        if(getCartupUidEle)
        var getCartupUid = getCartupUidEle.getAttribute("content");
        if(getCartupUid)
           window.sessionStorage.cartup_uid = getCartupUid;
        spotdyData = functionToAddOtherData.addOtherData(data);

        cartupRetries(1000, 1, function(){
            getAndSendDataToServer.begin(data, { type: "load" });
        })
        
        sendPendingEvents();
    }

    function sendPendingEvents() {
        if (!isEmpty(window.sessionStorage.pendingrequests)) {
            var requests = JSON.parse(window.sessionStorage.pendingrequests);
            window.sessionStorage.pendingrequests = "";

            while (requests.length > 0) {
                var url = requests.pop();
                var xhttp = spotdyGetXmlHttpObject();
                xhttp.myurl = url;
                xhttp.onreadystatechange = function () {
                    if (xhttp.readyState == 4 && xhttp.status == 200) {
                    } else if (xhttp.readyState == 4) {
                        var requests = [];
                        if (!isEmpty(window.sessionStorage.pendingrequests)) {
                            requests = JSON.parse(window.sessionStorage.pendingrequests);
                        }
                        requests.push(xhttp.myurl);
                        window.sessionStorage.pendingrequests = JSON.stringify(requests);
                    }
                };
                xhttp.open("GET", url, true);
                xhttp.send();
            }
        }
    }

    var addEventProperties = (function () {
        var eventAction = "";
        var innerText, eventPageUrl;
        var configEventDataObject;

        var addEventBasedProperties = function (spotdyData, e) {
            eventPageUrl = window.location.href;
            if (!e || !e.type)
                return;
            spotdyData.properties["eventAction"] = {"type": "string", "value": e.type.toString()};
            eventAction = e.type;
            if (e.type == "load")
                return;
            try {
                var event = e.srcElement || e.target || e || {};
                innerText = event.innerText || event.innerHTML || "";
                if(event.value)
                spotdyData.properties["eventValue"] = {"type": "string", "value": event.value.toString()};
                if (event.nodeName && event.nodeName.toLowerCase() == "img" && event.currentSrc)
                    spotdyData.properties["imgSrc"] = {"type": "string", "value": event.currentSrc.toString()};
                if (innerText && !isHTML(innerText))
                    spotdyData.properties["innerText"] = {"type": "string", "value": innerText.trim().toString()};
                var cssSelector = "";
                cssSelector += event.nodeName.toLowerCase();
                if (event.id)
                    cssSelector += "#" + event.id;
                if (event.className)
                    if(typeof(event.className) === 'string')
                        cssSelector += "." + event.className.split(" ").join(".");
                if (cssSelector)
                spotdyData.properties["cssSelector"] = {"type": "string", "value": cssSelector.toString()};
            } catch (err) {
                console.log(err);
            }
        };

        var getEventActionObjectArray = function (spotdyData) {
            configEventDataObject = [];
            if(spotdyEventsConfigData.events){
                if (eventAction == "change" && spotdyEventsConfigData.events.onChange.length > 0) {
                    configEventDataObject = spotdyEventsConfigData.events.onChange;
                } else if (eventAction == "load" && spotdyEventsConfigData.events.onLoad.length > 0) {
                    configEventDataObject = spotdyEventsConfigData.events.onLoad;
                } else if (eventAction == "click" && spotdyEventsConfigData.events.onClick.length > 0) {
                    configEventDataObject = spotdyEventsConfigData.events.onClick;
                }
            }
        };

        var sendDataInTimeOut = function (dp, sd) {
            getAndSendDataToServer.addAndSendData(dp, JSON.parse(JSON.stringify(sd)));
        }

        var assignEventType = function (spotdyData, event) {
            var configEventDataObjectLength = configEventDataObject.length;
            for (var index = 0; index < configEventDataObjectLength; index++) {
                var configeventdata = configEventDataObject[index];
                var flagToMatchTheGivenfield = 0;
                var outerContainer = "";
                if (configeventdata.innerHTML && innerText) {
                    configeventdata.innerHTML = configeventdata.innerHTML
                        .trim();
                    if (innerText)
                        innerText = innerText.trim();
                    if (configeventdata.innerHTML.toLowerCase() == innerText
                        .toLowerCase()) {
                        flagToMatchTheGivenfield = 1;
                    } else {
                        flagToMatchTheGivenfield = 0;
                        continue;
                    }
                }
                if (configeventdata.pageUrl && eventPageUrl) {
                    if (eventPageUrl.indexOf(configeventdata.pageUrl) != -1) {
                        flagToMatchTheGivenfield = 1;
                    } else {
                        flagToMatchTheGivenfield = 0;
                        continue;
                    }
                }
                
                if (configeventdata.cssSelector) {
                    var arrayOfContainer = [];
                    var elementArray, elementArrayLength;
                    arrayOfContainer = configeventdata.cssSelector.split('>');
                    var arrayOfContainerLength = arrayOfContainer.length
                    for (var index1 = 0; index1 < arrayOfContainerLength; index1++) {
                        var selector = arrayOfContainer[index1];
                        if (index1 == arrayOfContainerLength - 1) {
                            outerContainer = outerContainer || document;
                            if(selector.indexOf(',') == 0) {
                                selector = selector.slice(1);
                            }
                            if(selector.indexOf(',') == selector.length -1){
                                selector = selector.slice(0, -1);
                            }
                            elementArray = outerContainer.querySelectorAll(selector);
                            if (!elementArray || (elementArray.length == 0)) {
                                flagToMatchTheGivenfield = 0;
                                break;
                            }
                            elementArrayLength = elementArray.length;
                            for (var indexOfElement = 0; indexOfElement < elementArrayLength; indexOfElement++) {
                                var element = elementArray[indexOfElement];
                                if (event && event.target && element && element.contains(event.target)) {
                                    flagToMatchTheGivenfield = 1;
                                    break;
                                }
                            }
                            break;
                        }
                        outerContainer = outerContainer || document;
                        outerContainer = outerContainer.querySelector(selector);
                        if (!outerContainer) {
                            flagToMatchTheGivenfield = 0;
                            break;
                        }
                    }
                    if (!flagToMatchTheGivenfield)
                        continue;
                }
                if (configeventdata.specificInfo) {
                    outerContainer = outerContainer || "document";
                    var element = functionToGetTheDOMElement.getDOMElement(
                        outerContainer, configeventdata.specificInfo);
                    if (element)
                        flagToMatchTheGivenfield = 1;
                    else {
                        flagToMatchTheGivenfield = 0;
                        continue;
                    }
                }
                if (flagToMatchTheGivenfield) {
                    if (configeventdata.eventType)
                    spotdyData.properties["eventType"] = {"type": "string", "value": configeventdata.eventType.toString()};
                    if (configeventdata.labelName)
                        spotdyData.properties["labelName"] = {"value": configeventdata.labelName.toString(), "type": "string"};
                    var data = JSON.parse(JSON.stringify(configeventdata.dataProvider));
                    var sd = JSON.parse(JSON.stringify(spotdyData));
                    if (spotdyData.properties.eventType.value) {
                        if (eventAction == "load") {
                            spotdyLoadEvents.push(spotdyData.properties.eventType.value);
                        }
                        sendDataInTimeOut(data, sd);
                    }
                }
            }
            
            // if (eventAction == "load") {
            //     spotdyData.properties["eventType"] = {"type": "string", "value": "view"};
            // } else 
            if (eventAction == 'click') {
                spotdyData.properties["eventType"] = {"type": "string", "value": "click"};
                return;
            }

            if (spotdyData.properties.eventType && spotdyData.properties.eventType.value) {
                var data = null;
                var sd = JSON.parse(JSON.stringify(spotdyData));
                sendDataInTimeOut(data, sd);
            }

        };
        return {
            addProperties: function (data, event) {
                var spotdyData = data;
                spodyData = addEventBasedProperties(spotdyData, event);
                spodyData = getEventActionObjectArray(spotdyData);
                assignEventType(spotdyData, event);
            }
        };
    })();

    var getProductData = (function () {
        var dataProvider = data;
        var spotdyData = {};
        var getDataFromSelectedElement = (function () {
            var getTheOuterContainer = function (event, dataObject) {
                var flag = 0;
                if (event && event.parentNode && event.parentNode.tagName)
                    while (event.parentNode.tagName != 'HTML') {
                        if (dataObject.tagName) {
                            if (event.tagName.toLowerCase() == dataObject.tagName
                                .toLowerCase()) {
                                flag = 1;
                            } else {
                                flag = 0;
                                event = event.parentNode;
                                continue;
                            }
                        }
                        if (dataObject.elmentId) {
                            if (event.id == dataObject.elementId) {
                                flag = 1;
                            } else {
                                flag = 0;
                                event = event.parentNode;
                                continue;
                            }
                        }
                        if (dataObject.className) {
                            if (event.className.includes(dataObject.className)) {
                                flag = 1;
                            } else {
                                flag = 0;
                                event = event.parentNode;
                                continue;
                            }
                        }
                        if (dataObject.attributes.attribute && dataObject.attributes.value) {
                            var attribute = dataObject.attributes.attribute;
                            var value = dataObject.attributes.value;
                            if (event.hasAttribute(attribute)) {
                                if (value == event.getAttribute(attribute)) {
                                    flag = 1;
                                } else {
                                    flag = 0;
                                    event = event.parentNode;
                                    continue;
                                }
                            } else {
                                flag = 0;
                                event = event.parentNode;
                                continue;
                            }
                        }

                        if (flag)
                            break;
                    }
                return event;
            };
            return {
                getData: function (htmlElementForData) {
                    var outerContainer = "";
                    var event = e.srcElement || e.target || e;
                    outerContainer = getTheOuterContainer(event,
                        htmlElementForData.outerContainer);
                    if (!outerContainer)
                        return;
                    var data = htmlElementForData.productData;
                    for (var key in data) {
                        var cssSelector = data[key];
                        cssSelector = cssSelector.cssSelector;
                        if (!cssSelector)
                            continue;
                        var arrayOfContainer = cssSelector.split(">");
                        var outerContainerIterator = outerContainer;
                        for (var index = 0; index < arrayOfContainer.length; index++) {
                            if (index == arrayOfContainer.length - 1) {
                                var obj = getObjectFromCssSelector.getObjectForProduct(arrayOfContainer[index]);
                                var productData;
                                if (obj) {
                                    productData = getTheDataFromDOMElement(outerContainer, obj);
                                    if (productData) {
                                        var dataObj = {"value": "", "type": "string"};
                                        dataObj.value = productData.toString();
                                        spotdyData.properties[key] = dataObj;
                                    }
                                }
                                break;
                            }
                            var obj = getObjectFromCssSelector.getObjectForProduct(arrayOfContainer[index]);
                            outerContainerIterator = functionToGetTheDOMElement.getDOMElement(outerContainerIterator, obj);
                            if (!outerContainerIterator)
                                break;
                        }
                    }
                }
            }
        })();
        // for repeated element
        var getDataFromRepeatedElement = function (dataOnLoad) {
            if (dataOnLoad.productData)
                dataJSON = dataOnLoad.productData;
            var outerContainer = "";
            var repeatedElements = "";
            if (dataOnLoad.outerContainer)
                outerContainer = functionToGetTheDOMElement.getDOMElement(
                    "document", dataOnLoad.outerContainer);
            else
                outerContainer = document;
            var productData = dataOnLoad.productData;
            if (dataOnLoad.repeatedElement) {
                repeatedElements = functionToGetTheDOMElement.getDOMElements(
                    outerContainer, dataOnLoad.repeatedElement);
                if (!repeatedElements || repeatedElements.length == 0)
                    return;
                for (var repeatedElementIndex = 0; repeatedElementIndex < repeatedElements.length; repeatedElementIndex++) {
                    var repeatedElement = repeatedElements[repeatedElementIndex];
                    var repeatedElementContainer = "";
                    for (var key in productData) {
                        repeatedElementContainer = repeatedElement;
                        var cssSelector = productData[key];
                        if (!cssSelector.cssSelector)
                            continue;
                        else
                            cssSelector = cssSelector.cssSelector;
                        if (!cssSelector)
                            continue;
                        var arrayOfContainer = cssSelector.split(">");
                        for (var index = 0; index < arrayOfContainer.length; index++) {
                            if (index == arrayOfContainer.length - 1) {
                                var obj = getObjectFromCssSelector.getObjectForProduct(arrayOfContainer[index]);
                                var data;
                                if (obj && repeatedElementContainer) {
                                    data = getTheDataFromDOMElement(repeatedElementContainer, obj);
                                    if (data && !spotdyData.properties[key]) {
                                        spotdyData.properties[key] = {
                                            "value": [],
                                            "type": "array",
                                            "element_type": "string"
                                        };
                                    }
                                    if (data && spotdyData.properties[key]) {
                                        spotdyData.properties[key].value.push(data);
                                    }
                                }
                                break;
                            }
                            var obj = getObjectFromCssSelector.getObjectForProduct(arrayOfContainer[index]);
                            repeatedElementContainer = functionToGetTheDOMElement.getDOMElement(repeatedElementContainer, obj);
                            if (!repeatedElementContainer)
                                break;
                        }
                    }
                }
            }
        };
        // for non-repeated element
        var getDataFromUniqueElement = function (data) {
            for (var key in data) {
                var cssSelector = data[key];
                var outerContainer = "";
                if (!cssSelector.cssSelector)
                    continue;
                else
                    cssSelector = cssSelector.cssSelector;
                if (!cssSelector)
                    continue;
                var arrayOfContainer = cssSelector.split(">");
                if(setClosestData === true){
                    cssSelector = event.target.offsetParent.querySelector(cssSelector);
                    if(cssSelector){
                        getTheDataFromTargetEle(key,cssSelector);
                    }
                }else{
                    for (var index = 0; index < arrayOfContainer.length; index++) {
                        if (index == arrayOfContainer.length - 1) {
                            var obj = getObjectFromCssSelector.getObjectForProduct(arrayOfContainer[index]);
                            var productData;
                            if (obj) {
                                if (!outerContainer) {
                                    productData = getTheDataFromDOMElement("document", obj);
                                } else {
                                    productData = getTheDataFromDOMElement(outerContainer, obj);
                                }
                                if (productData) {
                                    var dataObj = {"value": "", "type": "string"};
                                    dataObj.value = productData.toString();
                                    spotdyData.properties[key] = dataObj;
                                }
                            }
                        }
                        var obj = getObjectFromCssSelector.getObjectForProduct(arrayOfContainer[index]);
                        if (!outerContainer) {
                            outerContainer = functionToGetTheDOMElement.getDOMElement(outerContainer ? outerContainer : "document", obj);
                        }
                        if (!outerContainer)
                            break;
                    }
                }
            }
        };

        var getTheDataFromTargetEle = function (key,domElement) {
            var data = domElement.innerText || domElement.innerHTML || domElement.value || domElement.src || domElement.href || domElement.content;
            if (data){
                data = data.trim().replace( /(<([^>]+)>)/ig, '');
                var dataTargetObj = {"value": "", "type": "string"};
                dataTargetObj.value = data.toString();
                spotdyData.properties[key] = dataTargetObj;
            }
            
        };

        var getDataFromMetada = function(productData){

            
            for(var key in productData){
                let arr = [];
                var cssSelector = productData[key].cssSelector;
                cssSelector = cssSelector.replace("meta", "").replace("[", "").replace("]", "").replaceAll("'", "");
                let name = cssSelector.split("=")[0];
                let value = cssSelector.split("=")[1];
                const metas = document.getElementsByTagName('meta');
                for (let i = 0; i < metas.length; i++) {
                    if (metas[i].getAttribute(name) === value) {
                        if(metas[i].getAttribute('content')){
                            arr.push(metas[i].getAttribute('content'));
                        }
                    }
                }
                spotdyData.properties[key] = { value : arr }; 
            }
        }

        return {
            getData: function (data, sd) {
                dataProvider = data;
                spotdyData = sd;
                //widget add to cart button click
                setClosestData = false;
                if(spotdyData.properties["innerText"]){
                    // var evtName = spotdyData.properties["innerText"].value;
                    // var evtType = spotdyData.properties["eventType"].value;
                    var evtLabel = spotdyData.properties.labelName.value;
                    var cssSel = spotdyData.properties["cssSelector"].value;
                    if(cssSel.includes('multipleAddToCartBtn')){
                        setClosestData = true;
                    }
                    if(evtLabel.includes('searchResult')){
                        setClosestData = true;
                    }
                }
                //end widget add to cart button click
                if (dataProvider) {
                    if (dataProvider.selectedElement && dataProvider.selectedElement.outerContainer
                        && !isEmpty(dataProvider.selectedElement)
                        && !isEmpty(dataProvider.selectedElement.outerContainer))
                        getDataFromSelectedElement.getData(dataProvider.selectedElement);
                    if (dataProvider.repeatedElement)
                        if (!(isEmpty(dataProvider.repeatedElement.outerContainer)
                            || isEmpty(dataProvider.repeatedElement.repeatedElement) || isEmpty(dataProvider.repeatedElement.productData))){
                                if(dataProvider.repeatedElement.repeatedElement.tagName && dataProvider.repeatedElement.repeatedElement.tagName.includes("head")){
                                    getDataFromMetada(dataProvider.repeatedElement.productData)
                                } else {
                                    getDataFromRepeatedElement(dataProvider.repeatedElement);
                                }
                        }
                    if (dataProvider.uniqueElement)
                        if (dataProvider.uniqueElement.productData && !isEmpty(dataProvider.uniqueElement.productData)) {
                            getDataFromUniqueElement(dataProvider.uniqueElement.productData);
                        }
                }
            }
        }
    })();

    var functionToAddOtherData = (function () {
        var spotdyData = {};
        var addDate = function () {
            spotdyData.properties["date"] = {"type": "ISO_DATE", "value": new Date().toISOString()};
        };
        var addSpotdyEventId = function () {
            if(generateUUID())
            spotdyData.properties["spotdy_eventid"] = {"value": generateUUID().toString(), "type": "string"};
        }
        var addIp = function () {
            if(window.sessionStorage.ipAddress)
            otherSpotdyData["ipAddress"] = {"type": "string", "value": window.sessionStorage.ipAddress.toString()};
        };
        var isMobile = {
            Android: function () {
                return navigator.userAgent.match(/Android/i);
            },
            BlackBerry: function () {
                return navigator.userAgent.match(/BlackBerry/i);
            },
            iOS: function () {
                return navigator.userAgent.match(/iPhone|iPad|iPod/i);
            },
            Opera: function () {
                return navigator.userAgent.match(/Opera Mini/i);
            },
            Windows: function () {
                return navigator.userAgent.match(/IEMobile/i);
            },
            any: function () {
                return (isMobile.Android() || isMobile.BlackBerry()
                    || isMobile.iOS() || isMobile.Opera() || isMobile
                        .Windows());
            }
        };

        function is_mobile() {
            if (isMobile.any()) {
                otherSpotdyData["is_mobile"] = {"type": "boolean", "value": true};
            } else {
                otherSpotdyData["is_mobile"] = {"type": "boolean", "value": false};
            }
        };
        var is_Mobile = function () {
            is_mobile();
        };
        var addDeviceInfo = function () {
            if(navigator.platform){
                otherSpotdyData["deviceInfo"] = {"type": "string", "value": navigator.platform.toString()};
                if (navigator.platform.toLowerCase().indexOf("win32") != -1) {
                    if (navigator.userAgent.indexOf("WOW64") != -1 ||
                        navigator.userAgent.indexOf("Win64") != -1) {
                        otherSpotdyData["deviceInfo"] = {"type": "string", "value": "Win64"};
                    }
                }
            }
        };
        var addBrowserInfo = function () {
            if (navigator.appName == 'Microsoft Internet Explorer') {
                if (navigator.appName)
                otherSpotdyData["browserInfo"] = {"type": "string", "value": navigator.appName.toString()}; // IE
            } else if (navigator.appName == "Netscape" && navigator.appVersion.indexOf('Edge') > -1) {
                otherSpotdyData["browserInfo"] = {"type": "string", "value": "Microsoft edge"};
            } else {
                var browserData = get_browser();
                var x = "";
                if (browserData.name) {
                    x += browserData.name;
                }
                if (browserData.version) {
                    x += " " + browserData.version;
                }
                if (x)
                otherSpotdyData["browserInfo"] = {"type": "string", "value": x.toString()};
            }
        };

        function get_browser() {
            var ua = navigator.userAgent, tem,
                M = ua.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i) || [];
            if (/trident/i.test(M[1])) {
                tem = /\brv[ :]+(\d+)/g.exec(ua) || [];
                return {name: 'IE', version: (tem[1] || '')};
            }
            if (M[1] === 'Chrome') {
                tem = ua.match(/\bOPR|Edge\/(\d+)/)
                if (tem != null) {
                    return {name: 'Opera', version: tem[1]};
                }
            }
            M = M[2] ? [M[1], M[2]] : [navigator.appName, navigator.appVersion, '-?'];
            if ((tem = ua.match(/version\/(\d+)/i)) != null) {
                M.splice(1, 1, tem[1]);
            }
            return {
                name: M[0],
                version: M[1]
            };
        }

        var addCurrentPageUrl = function () {
            spotdyData.properties["currentPageUrl"] = {"type": "string", "value": window.location.href.toString()};
        };

        function getCookie(cname) {
            var name = cname + "=";
            var ca = document.cookie.split(';');
            for (var i = 0; i < ca.length; i++) {
                var c = ca[i];
                while (c.charAt(0) == ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(name) == 0) {
                    return c.substring(name.length, c.length);
                }
            }
            return "";
        }

        function setCookie(cname, cvalue, exdays) {
            var d = new Date();
            d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
            var expires = "expires=" + d.toUTCString();
            document.cookie = cname + "=" + cvalue + "; " + expires;
        }
        var addCookies = function () {
            var spotdyUidCookieValue = getCookie("spotDy_uid");
            if(window.sessionStorage.cartup_uid)
                spotdyUidCookieValue = window.sessionStorage.cartup_uid;
            if (spotdyUidCookieValue) {
                otherSpotdyData["spotDy_uid"] = {"type": "string", "value": spotdyUidCookieValue.toString()};
            } else {
                otherSpotdyData["spotDy_uid"] = {"type": "string", "value": generateUUID().toString()};
                setCookie("spotDy_uid", otherSpotdyData["spotDy_uid"].value,
                    180);
            }
            window.localStorage.spotDy_uid = otherSpotdyData["spotDy_uid"].value;
            if(getCookie('_ga'))
            otherSpotdyData["_ga"] = {"type": "string", "value": getCookie('_ga').toString()};
            if(getCookie('_fbp'))
            otherSpotdyData["_fbp"] = {"type": "string", "value": getCookie('_fbp').toString()};
        };
        var addReferralDomainName = function () {
            if(document.referrer)
            spotdyData.properties["referralDomainName"] = {"type": "string", "value": document.referrer.split('/')[2].toString()};
        };
        var addReferralData = function () {
            if(document.referrer)
            spotdyData.properties["referralUrl"] = {"type": "string", "value": encodeURI(document.referrer).toString()};
        };
        var assignSessionId = function () {
            if (sessionStorage.sessionId)
                spotdySession = JSON.parse(sessionStorage.sessionId);
            var currentTime = new Date();
            if (spotdySession.expTime) {
                if (((currentTime - new Date(spotdySession.expTime)) / 36e5) > 1){
                    spotdySession.id = generateUUID();
                    spotdyData.properties["is_session_start"] = {"type": "boolean", "value": true};
                }
            } else {
                spotdySession.id = generateUUID();
                spotdyData.properties["is_session_start"] = {"type": "boolean", "value": true};
            }
            document.cookie = "sessionId="+spotdySession.id;
            spotdySession.expTime = currentTime;
            if(spotdySession.id)
            spotdyData.properties["spotdySessionId"] = {"type": "string", "value": spotdySession.id.toString()};
            sessionStorage.sessionId = JSON.stringify(spotdySession);
        };
        var addDomain = function () {
            otherSpotdyData["domain"] = {"type": "string", "value": window.location.hostname.toString()};
        };
        var addOrg = function () {
            if(spotdyEventsConfigData.org)
            otherSpotdyData["org"] = {"type": "string", "value": spotdyEventsConfigData.org.toString()};
            if(spotdyEventsConfigData.orgId)
            otherSpotdyData["orgId"] = {"type": "string", "value": spotdyEventsConfigData.orgId.toString()};
        };
        var addFrameWork = function () {
            if(spotdyEventsConfigData.frameWork)
            otherSpotdyData["framework"] = {"type": "string", "value": spotdyEventsConfigData.frameWork.toString()};
        };
        return {
            addOtherData: function (data) {
                spotdyData = data;
                if (!otherSpotdyData) {
                    otherSpotdyData = window.sessionStorage.otherSpotdyData || {};
                    if (Object.keys(otherSpotdyData).length === 0) {
                        // addGeolocation();
                        addIp();
                        is_Mobile();
                        addDeviceInfo();
                        addBrowserInfo();
                        addCookies();
                        addOrg();
                        addDomain();
                        addFrameWork();
                        window.sessionStorage.otherSpotdyData = JSON.stringify(otherSpotdyData);
                    } else {
                        otherSpotdyData = JSON.parse(otherSpotdyData);
                    }
                }
                for (var key in otherSpotdyData) {
                    spotdyData.properties[key] = otherSpotdyData[key];
                }
                addDate();
                addCurrentPageUrl();
                addReferralData();
                addReferralDomainName();
                addSpotdyEventId();
                assignSessionId();
                return spotdyData;
            }
        }
    })();

    var functionToAddListener = (function () {
        var addListenerToOnChangeElements = function () {
            var selects = document.getElementsByTagName("select");
            for (var i = 0; i < selects.length; i++) {
                selects[i].addEventListener("change", function (ev) {
                    if (!ev.isTrusted) {
                        return;
                    }
                    getAndSendDataToServer.begin(initializeData(), ev);
                });
            }
            var inputs = document.getElementsByTagName("input");
            for (var i = 0; i < inputs.length; i++) {
                inputs[i].addEventListener("change", function (ev) {
                    if (!ev.isTrusted) {
                        return;
                    }
                    getAndSendDataToServer.begin(initializeData(), ev);
                });
            }
            var textareas = document.getElementsByTagName("textarea");
            for (var i = 0; i < textareas.length; i++) {
                textareas[i].addEventListener("change", function (ev) {
                    if (!ev.isTrusted) {
                        return;
                    }
                    getAndSendDataToServer.begin(initializeData(), ev);
                });
            }
        };
        var addListenerToClickElements = function () {
            window.sessionStorage.isClickEventFired = "0";
            window.addEventListener('click', function (ev) {
                var getId="";
                if(ev.target.className)
                if(typeof(ev.target.className) === 'string'){
                    if(ev.target.className.includes('similarSearchEle')){
                        getId =  (ev.target.id).replace(/\D/g,'');
                        toggleSimilarSearch(getId)
                    }
                }
                if(ev.target.parentElement)
                if(ev.target.parentElement.className)
                if(typeof(ev.target.parentElement.className) === 'string'){
                    if(ev.target.parentElement.className.includes('similarSearchEle')){
                        getId =  (ev.target.parentElement.id).replace(/\D/g,'');
                        toggleSimilarSearch(getId)
                    }
                }
                // if(ev.target.getElementsByClassName('similarSearchEle')){
                //     if(ev.target.getElementsByClassName('similarSearchEle').length>0){
                //         getId =  (ev.target.getElementsByClassName('similarSearchEle')[0].id).replace(/\D/g,'');
                //         toggleSimilarSearch(getId)
                //     }
                // }

                if(ev.target.className)
                if(typeof(ev.target.className) === 'string'){
                    if(ev.target.className.includes('dotTypeIcon') || ev.target.className.includes('closeDots') || ev.target.className.includes('popOverDiv'))
                    {
                        ev.preventDefault();
                            if(ev.target.className.includes('popOverDiv'))
                            var popOutEleAlt = ev.target.getElementsByClassName('closeDots')[0].getAttribute('alt');
                            else
                            var popOutEleAlt = ev.target.getAttribute('alt');

                            if(popOutEleAlt){
                                var popOutEle1 = document.getElementById('dotType_'+popOutEleAlt);
                                popOutEle1.classList.toggle('rot');
                            }

                    }else{
                        //ev.preventDefault();
                        if(document.getElementsByClassName('popOverDiv').length>0){
                            for(var i=0;i<document.getElementsByClassName('popOverDiv').length;i++){
                                document.getElementsByClassName('popOverDiv')[i].classList.remove('rot');
                                document.getElementsByClassName('dotTypeIcon')[i].querySelector('.closePopup').classList.remove('closePopupdivRot');
                            }
                        }
                    }
                }
                
                if(ev.target.className.baseVal){
                    if(ev.target.className.baseVal.includes('closePopup')){
                        ev.preventDefault();
                            var popOutEleAlt = ev.target.getAttribute('alt');
                            // for(let i=0;i<document.getElementsByClassName('popOverDiv').length;i++){
                            //     document.getElementsByClassName('popOverDiv')[i].classList.remove('rot');
                            //     document.getElementsByClassName('popOverDiv')[i].classList.remove('closePopupdivRot');
                            // }
                            
                            if(popOutEleAlt){
                                var popOutEle1 = document.getElementById('dotType_'+popOutEleAlt);
                                popOutEle1.classList.toggle('rot');
                                var popOutEle2 = document.getElementById('dotType'+popOutEleAlt);
                                popOutEle2.querySelector('.closePopup').classList.toggle('closePopupdivRot');

                                if(document.getElementsByClassName('popOverDiv').length>0){
                                    for(var i=0;i<document.getElementsByClassName('popOverDiv').length;i++){
                                        if(document.getElementsByClassName('popOverDiv')[i].id !== 'dotType_'+popOutEleAlt){
                                            document.getElementsByClassName('popOverDiv')[i].classList.remove('rot');
                                            document.getElementsByClassName('dotTypeIcon')[i].querySelector('.closePopup').classList.remove('closePopupdivRot');
                                        }
                                    }
                                }
                            }

                    }
                }else{
                    if(document.getElementsByClassName('popOverDiv').length>0){
                        for(let i=0;i<document.getElementsByClassName('popOverDiv').length;i++){
                            document.getElementsByClassName('popOverDiv')[i].classList.remove('rot');
                            document.getElementsByClassName('popOverDiv')[i].classList.remove('closePopupdivRot');
                            document.getElementsByClassName('dotTypeIcon')[i].querySelector('.closePopup').classList.remove('closePopupdivRot');
                        }
                    }
                }
                if (ev === undefined) ev = window.event;
                if (!ev.isTrusted)
                    return;
                let isClickEventFired = window.sessionStorage.isClickEventFired;
                if(isClickEventFired == "0"){
                    window.sessionStorage.isClickEventFired = "1";
                    getAndSendDataToServer.begin(initializeData(), ev);
                    setTimeout(function(){
                        window.sessionStorage.isClickEventFired = "0";
                    }, 1000);
                }
            }, true);
        };
        var addListenerToOnLoadPage = function () {
            document.addEventListener(
                "load",
                function (ev) {
                    spotdyFlagForLoad = 1;
                }, true);
        };
        return {
            addListeners: function () {
                if (!isEmpty(spotdyEventsConfigData)) {
                    if (spotdyEventsConfigData.track.onClick === true)
                        addListenerToClickElements();
                    if (spotdyEventsConfigData.track.onChange === true)
                        addListenerToOnChangeElements();
                    if (spotdyEventsConfigData.track.onLoad === true)
                        addListenerToOnLoadPage();
                }
            }
        }
    })();

    var functionToGetTheDOMElement = (function () {
        var generateQueryStringSelector = function (data) {
            var querySelectorString = "";
            if (data.elementId) {
                querySelectorString = data.elementId;
                return "#" + querySelectorString;
            }
            if (data.tagName) {
                querySelectorString = data.tagName;
            }
            if (data.className) {
                var className = replaceOneStringWithAnother(data.className,
                    " ", ".");
                querySelectorString += "." + className;
            }
            return querySelectorString;
        };
        var replaceOneStringWithAnother = function (string, find, replace) {
            return string.split(find).join(replace);
        };
        return {
            getDOMElement: function (outerContainer, dataObject) {
                try {
                    if (!dataObject) return;
                    var elements;
                    var querySelectorString = generateQueryStringSelector(dataObject);
                    if (isString(outerContainer)
                        && outerContainer != "document" && outerContainer != "body")
                        outerContainer = strToHTML(outerContainer);
                    if (outerContainer == "document" || outerContainer == "body")
                        elements = document.querySelectorAll(querySelectorString);
                    else
                        elements = outerContainer.querySelectorAll(querySelectorString);
                    if (elements && elements.length > 0) {
                        if (dataObject.hasOwnProperty("attributeAndValueArray")) {
                            for (var index1 = 0; index1 < elements.length; index1++) {
                                var flag = 0;
                                var attributeAndValueArray = dataObject.attributeAndValueArray;
                                for (var index2 = 0; index2 < attributeAndValueArray.length; index2++) {
                                    if (elements[index1]
                                        .getAttribute(attributeAndValueArray[index2].attribute) == attributeAndValueArray[index2].value)
                                        flag = 1;
                                    else {
                                        flag = 0;
                                        break;
                                    }
                                }
                                if (flag)
                                    return elements[index1];
                            }
                            return "";
                        }
                        if (dataObject.attributes && dataObject.attributes.attribute && dataObject.attributes.value) {
                            for (var index = 0; index < elements.length; index++) {
                                if (elements[index]
                                    .getAttribute(dataObject.attributes.attribute) === dataObject.attributes.value) {
                                    return elements[index];
                                }
                            }
                        }
                        return elements[0];
                    }
                } catch (err) {
                }
            },
            getDOMElements: function (outerContainer, dataObject) {
                try {
                    if (!dataObject) return;
                    var querySelectorString = generateQueryStringSelector(dataObject);
                    if (isString(outerContainer) && outerContainer != "document")
                        outerContainer = strToHTML(outerContainer);
                    if (outerContainer == "document")
                        return document.querySelectorAll(querySelectorString);
                    else
                        return outerContainer.querySelectorAll(querySelectorString);
                } catch (err) {}
            }
        }
    })();

    function isHTML(str) {
        var a = document.createElement('div');
        a.innerHTML = str;
        for (var c = a.childNodes, i = c.length; i--;) {
            if (c[i].nodeType == 1)
                return true;
        }
        return false;
    }

    function isString(val) {
        return typeof val === 'string'
            || ((!!val && typeof val === 'object') && Object.prototype.toString
                .call(val) === '[object String]');
    }

    function strToHTML(str) {
        var d = document.createElement('div');
        d.innerHTML = str;
        return d.firstChild;
    }

    var getTheDataFromDOMElement = function (outerContainer, dataObject) {
        var domElement = "";
        if (dataObject.tagName.toLowerCase() == "input") {
            var domElements = functionToGetTheDOMElement.getDOMElements(
                outerContainer, dataObject);
            if (!domElements || domElements.length <= 0)
                return;
            if (domElements[0].getAttribute("type").toString().toLowerCase() != "radio") {
                domElement = domElements[0];
            } else {
                for (var index = 0; index < domElements.length; index++) {
                    if (domElements[index].checked) {
                        domElement = domElements[index];
                        break;
                    }
                }
            }
        } else {
            domElement = functionToGetTheDOMElement.getDOMElement(
                outerContainer, dataObject);
        }
        if (!domElement) return;
        var substr = dataObject.substr;
        var data = "";
        if (dataObject.attribute && domElement.hasAttribute(dataObject.attribute)) {
            data = domElement.getAttribute(dataObject.attribute)
                || domElement.value;
        } else if (domElement && dataObject && dataObject.tagName && dataObject.tagName.toLowerCase() == "select") {
            data = domElement.options[domElement.selectedIndex].value;
        } else {
            data = domElement.innerText || domElement.innerHTML || domElement.value || domElement.src || domElement.href || domElement.content;
        }
        if(window.sessionStorage.orgId === '3497a374-ad61-4187-a0b8-14bd3b46e88f' && (domElement.name === 'search_query' || domElement.name === 'cartup-search-input')){
            var urlParams1 = new URLSearchParams(window.location.search);
            var myParam1 = urlParams1.get('search_query');
            if(myParam1)
            data = myParam1
        }
        if (data)
            data = data.trim().replace( /(<([^>]+)>)/ig, '');
        else
            return data;

        if (substr) {
            try {
                if (substr.indexOf(":") != -1) {
                    // remove prefix
                    if (substr.indexOf(":") == (substr.length - 1)) {
                        substr = substr.substring(0, substr.length - 1);
                        data = data.substring(0, parseInt(substr));
                    } else {
                        // remove postfix
                        substr = substr.substring(1, substr.length);
                        data = data.substring(parseInt(substr), data.length);
                    }
                } else {
                    if (substr.indexOf(",") != -1) {
                        data = data.substring(parseInt(substr.split(",")[0]), parseInt(substr.split(",")[1]));
                    }
                }
            } catch (err) {
            }
        }
        return data;
    };

    var getObjectFromCssSelector = (function () {

        var addSubStr = function (cssSelector) {
            var data = {
                elementId: "",
                className: "",
                tagName: "",
                attributes: {
                    attribute: "",
                    value: ""
                },
                attribute: "",
                substr: ""
            };
            if (cssSelector.indexOf("-[[") != -1) {
                cssSelector = cssSelector.substr(0, cssSelector.length - 2);
                data.substr = cssSelector.split("-[[")[1];
                cssSelector = cssSelector.split("-[[")[0];
            }
            return {data: data, cssSelector: cssSelector};
        }

        var getCSSObject = function (selector) {
            var obj = {
                elementId: "",
                tagName: "",
                className: "",
                attributes: {
                    attribute: "",
                    value: ""
                },
                attribute: ""
            }
            if (selector.indexOf("{{") != -1) {
                selector = selector.substr(0, selector.length - 2);
                var strOfAttribute = selector.split("{{")[1];
                selector = selector.split("{{")[0];
                if (strOfAttribute.indexOf("=") != -1) {
                    obj.attributes.attribute = strOfAttribute.split("=")[0];
                    obj.attributes.value = strOfAttribute.split("=")[1];
                }
            }
            if (selector.indexOf("$") != -1) {
                obj.attribute = selector.split("$")[1];
                selector = selector.split("$")[0];
            }
            if (selector.indexOf(".") != -1) {
                var classString = selector.substr(selector.indexOf("."), selector.length);
                obj.className = classString.split(".").join(" ").trim();
                selector = selector.split(".")[0];
            }
            if (selector.indexOf("#") != -1) {
                obj.elementId = selector.split("#")[1];
                selector = selector.split("#")[0];
            }
            obj.tagName = selector;
            return obj;
        }

        var getCSSString = function (obj) {
            if (!obj) return;
            var str = "";
            if (obj.tagName)
                str = obj.tagName;
            if (obj.elementId)
                str += "#" + obj.elementId;
            if (obj.className) {
                var temp = obj.className;
                temp = temp.split(" ").join(".");
                str += "." + temp;
            }
            if (obj.attribute) {
                str += "$" + obj.attribute;
            }
            if (obj.attributes && obj.attributes.attribute && obj.attributes.attribute) {
                str += "{{" + obj.attributes.attribute + "=" + obj.attributes.value + "}}";
            }
            if (obj.substr) {
                str += "-[[" + obj.substr + "]]";
            }
            return str;
        }
        // substr is present
        return {
            getObjectForProduct: function (cssSelector) {
                if (!cssSelector) return;
                var data = {};
                data = addSubStr(cssSelector);
                cssSelector = data.cssSelector;
                data = data.data;
                var tempObj = getCSSObject(cssSelector);
                data.elementId = tempObj.elementId;
                data.className = tempObj.className;
                data.attributes = tempObj.attributes;
                data.tagName = tempObj.tagName;
                data.attribute = tempObj.attribute;
                return data;
            },
            getCSSObject: getCSSObject,
            getStringFromObject: getCSSString
        };
    })();

    spotdySpecificLoadWidget();
    functionToExecuteAfterLoad(initializeData());

    var sendWidgetViewsOnScroll = function() {

        var sendWidgetView = function () {
            for (var key in allSpotdyWidgetData) {
                widget = allSpotdyWidgetData[key];
                var element = widget?.element;
                var isDomVal = 0;
                if(widget.isDomBased == true){
                    isDomVal = 1
                    element = document.getElementById('cartup_'+key)
                }
                if (element && (widget?.count == 0) && element?.style?.display != "none" && element?.innerHTML != '') {
                    isViewed = isInViewport(element);
                    if (isViewed) {
                        widget.count = 1;
                        sendWidgetViewEvent(key,isDomVal);
                    }
                }
            }
        }

        var init = function () {
            sendWidgetView();
            window.addEventListener('scroll', function (event) {
                sendWidgetView();
            });
        }

        function isInViewport(element) {
            const rect = element.getBoundingClientRect();
            return (
                // rect.top >= 0 &&
                // rect.left >= 0 &&
                rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
                rect.right <= (window.innerWidth || document.documentElement.clientWidth)
            );
        }

        var sendWidgetViewEvent = function (widgetName,isDom) {
            var data = {};
            data['properties'] = {};
            data.properties['spotdy_eventname'] = {
                "value": "__widget_view__",
                "type": "string"
            };
            data.properties['eventType'] = {
                "value": "__widget_view__",
                "type": "string"
            };
            if(widgetName){
                data.properties['widgetId'] = {
                    "value": widgetName.toString(),
                    "type": "string"
                };
                data.properties['sku'] = {
                    "value": getProductSkus(widgetName),
                    "type": "array",
                    "element_type": "string"
                }
            }
            getAndSendDataToServer.addAndSendData("", data);
        }
        function getProductSkus(widgetName) {
            if(!allSpotdyWidgetData[widgetName]["data"]) return [];
            let skus = [];
            for(let index = 0; index < allSpotdyWidgetData[widgetName]["data"].length; index++){
                skus.push(allSpotdyWidgetData[widgetName]["data"][index].sku);
            }
            return skus;
        }
        return {
            init: init()
        }
    }

    functionToAddListener.addListeners();
    sendWidgetViewsOnScroll();
}

//Generic

function cartupRetries(timeout, retries, op) {
    let count = 0;
    let intervalOp = setInterval(function() {
        count++;
        let res = op();
        if(res === true || count >= retries){
            clearInterval(intervalOp);
        }
    }, timeout);
}

function isEmpty(obj) {
    var hasOwnProperty = Object.prototype.hasOwnProperty;
    if (obj == null)
        return true;
    if (obj.length > 0)
        return false;
    if (obj.length === 0)
        return true;
    if (typeof obj !== "object")
        return true;
    for (var key in obj) {
        if (hasOwnProperty.call(obj, key))
            return false;
    }
    return true;
}

var functionToMakeAJAXCall = function (type, requiredFields, productInfo) {
    if(type == 'Staging_pdp_crossSell' && window.location.host == 'www.dubaistore.com')
    return;
    var urlToGetTheDataForWidget = urlToGetTheWidgetDataFromTheServer + "custom?divisionId=" + type;
    var urlToGetTheDataForWidgetAPI = urlToGetTheWidgetDataFromTheServer + "custom";
    var getdivisionId = type
    var getcatquery = null;
    var getpname = null;
    var getsku = null;
    var getorgId = null;
    var getdomain = null;
    var getlogin = null;
    var getspotDy_uid = null;
    var getsessionId = null;
    var getsitedomain = null;
    var getcom = null;
    if(!cartUpPageType){
        if(!cartUpPageType && window.sessionStorage.cartupPageMeta){
            config = JSON.parse(window.sessionStorage.cartupPageMeta)
            for(var key in config) {
                let obj = config[key].pageMeta;
                let cssSelector = obj.cssSelector.info;
                let metaInfo = obj.metaInfo.info;
                if(GetCartupCssSelectorNode(document, cssSelector) || IsCartupMetaMatching(metaInfo) || isUrlMatching(obj.urlInfo.pageUrl)){
                    cartUpPageType = key;
                    window.sessionStorage.cartupPageType = key;
                }
            }
        }else{
            cartUpPageType = window.sessionStorage.cartupPageType;
        }
    }
        
    if(requiredFields && requiredFields.length > 0){
        let keys = ["productName", "category"];
        for(let index = 0; index < keys.length; index++){
            let key = keys[index];
            if(requiredFields.includes(key)){
                let key1 = key;
                if(key == "productName" && cartUpPageType == "CheckOutPage") {
                    key1 = "productName1";
                }
                if(key == "productName" && cartUpPageType.toLowerCase() == "cartpage") {
                    key1 = "multipleProductName";
                }
                if(!productInfo[key1]) return false;
                let element = GetCartupCssSelectorNode(document, productInfo[key1].cssSelector);
                //if(!element || !element.innerText) return false;
                if(!element){
                    if(key == "productName"){
                        urlToGetTheDataForWidget = urlToGetTheDataForWidget;
                        break;
                    } else if(key == "category"){
                        urlToGetTheDataForWidget = urlToGetTheDataForWidget;
                    }
                }else{
                    if(key == "productName"){
                        if(cartUpPageType.toLowerCase() == "cartpage"){
                            var proNameArr = [];
                            if(element.tagName === 'META'){
                                var proNameArr = [];
                                let metasEle = document.getElementsByTagName('meta');
                                for (let i = 0; i < metasEle.length; i++) {
                                    if (metasEle[i].getAttribute('name') === element.getAttribute('name')) {
                                        if(metasEle[i].getAttribute('content')){
                                            proNameArr.push((metasEle[i].getAttribute('content')));
                                        }
                                    }
                                }
                            }else{
                                var proNameArr = [];
                                if(!element.length){
                                    if(element.className)
                                    if(document.getElementsByClassName(element.className).length>0)
                                    element = document.getElementsByClassName(element.className)
                                    for(var i=0;i<element.length;i++){
                                        if(element[i].content)
                                        proNameArr.push((element[i].content))
                                        else
                                        if(element[i].innerText)
                                        proNameArr.push((element[i].innerText))
                                    }
                                }else{
                                    for(var i=0;i<element.length;i++){
                                        if(element[i].content)
                                        proNameArr.push((element[i].content))
                                        else
                                        if(element[i].innerText)
                                        proNameArr.push((element[i].innerText))
                                    }
                                }
                                // if(!element.length && element){
                                //     if(element.content)
                                //     proNameArr.push((element.content))
                                //     else
                                //     if(element.innerText)
                                //     proNameArr.push((element.innerText))
                                // }


                            }
                            if(proNameArr.length>0)
                            getpname = proNameArr
                            //urlToGetTheDataForWidget += "&pname=" + JSON.stringify(proNameArr);
                        }else{
                            if(element.content)
                            getpname = element.content;
                            else
                            getpname = element.innerText;
                        }
                        break;
                    } else if(key == "category"){
                        cartUpPageType = "cate"
                        getcatquery = element.innerText;
                        urlToGetTheDataForWidget += "&catquery="+ encodeURIComponent((element.innerText.toLowerCase()).trim());
                        break;
                    }
                }
            }
        }
    }
    var getsku = getCartupProductSku() || null;
       // urlToGetTheDataForWidget += "&sku=" + getsku;
    if (window.sessionStorage.orgId){
        getorgId = window.sessionStorage.orgId;
      //  urlToGetTheDataForWidget += "&orgId=" + window.sessionStorage.orgId;
    }
    // if (window.sessionStorage.frameWork) {
    //     if (window.sessionStorage.frameWork.toLowerCase() == 'magento 2.x')
    //         urlToGetTheDataForWidget += "&domain=" + "magento";
    //     else if (window.sessionStorage.frameWork.toLowerCase() == 'magento 1.x')
    //         urlToGetTheDataForWidget += "&domain=" + "magento1";
    //     else
    //         urlToGetTheDataForWidget += "&domain=magento";
    // }
    getdomain = "magento";
    if (window.localStorage.spotdyUserId){
        getlogin = window.localStorage.spotdyUserId;
        //getspotdyUserId = window.localStorage.spotdyUserId;
        //urlToGetTheDataForWidget += "&login=" + window.localStorage.spotdyUserId;
    }
    if (window.localStorage.spotDy_uid){
        getspotDy_uid = window.localStorage.spotDy_uid
        //urlToGetTheDataForWidget += "&spotDy_uid=" + window.localStorage.spotDy_uid;
    }
    if (window.sessionStorage.sessionId){
        var getsessionId = JSON.parse(window.sessionStorage.sessionId).id
       // urlToGetTheDataForWidget += "&sessionId=" + getsessionId;
    }
        
    
    var currentPageUrl = window.location.hostname;
    if (currentPageUrl.includes("www")) {
        getsitedomain = currentPageUrl.split(".")[1];
        //urlToGetTheDataForWidget += "&sitedomain=" + currentPageUrl.split(".")[1];
    } else {
        getsitedomain = currentPageUrl.split(".")[0];
        //urlToGetTheDataForWidget += "&sitedomain=" + currentPageUrl.split(".")[0];
    }
    getcom = spotdyEventsConfigData.org;
    //urlToGetTheDataForWidget += "&com=" + spotdyEventsConfigData.org;
    var payloadObj = {
    'pname':getpname,
    'catquery':getcatquery,
    'divisionId': getdivisionId,
    'sku': getsku,
    'orgId': getorgId,
    'domain': getdomain,
    'spotDy_uid': getspotDy_uid,
    'sessionId': getsessionId,
    'sitedomain': getsitedomain,
    'com': getcom}
    var xhttp = spotdyGetXmlHttpObject();
    xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
            var data = {};
            try {
                // if(window.sessionStorage.orgName === 'dubaistore'){
                //     this.responseText = {
                //         "errMsg": null,
                //         "numberofdocs": 20,
                //         "success": "0",
                //         "widgetType": "recentviews",
                //         "widgetId": "recentviews",
                //         "fallbackWidgetId": null,
                //         "mainWidgetId": "recentviews",
                //         "themeId": "b34791ac-ef67-4509-99d0-1325bcbacec2",
                //         "products": [
                //             {
                //                 "name": "Steel Snap Hook w/ Fixed Eye",
                //                 "productId": "241",
                //                 "sku": "USR-01-CF07",
                //                 "price": "18.49",
                //                 "smallImage": "https://cdn11.bigcommerce.com/s-rcvl76lfrq/products/241/images/555/USR-01-CF07_-_STEEL_SNAP_HOOK_W_EYE__65347.1518633619.190.285.jpg?c=2",
                //                 "currentPageUrl": "https://usrigging.com/proclimb-ansi-double-action-steel-snap-hook/",
                //                 "badging": [],
                //                 "stock": 861
                //             },
                //             {
                //                 "name": "Forged Aluminum Snap Hook w/ Fixed Eye - Blue",
                //                 "productId": "307",
                //                 "sku": "USR-50-AB",
                //                 "price": "22.49",
                //                 "smallImage": "https://cdn11.bigcommerce.com/s-rcvl76lfrq/products/307/images/562/USR-50-AB_-_FORGED_ALUM_SNAPHOOK_W_EYE__98527.1518633374.190.285.jpg?c=2",
                //                 "currentPageUrl": "https://usrigging.com/proclimb-aluminum-double-lock-hook/",
                //                 "badging": [],
                //                 "stock": 4400
                //             },
                //             {
                //                 "name": "Steel Ladder Hook",
                //                 "productId": "315",
                //                 "sku": "USR-71-CTS",
                //                 "price": "27.99",
                //                 "smallImage": "https://cdn11.bigcommerce.com/s-rcvl76lfrq/products/315/images/514/USR-71-CTS_-_STEEL_LADDER_HOOK__58317.1518633343.190.285.jpg?c=2",
                //                 "currentPageUrl": "https://usrigging.com/proclimb-nfpa-steel-ladder-hook-screw-lock/",
                //                 "badging": [],
                //                 "stock": 432
                //             },
                //             {
                //                 "name": "Steel Snap Hook",
                //                 "productId": "335",
                //                 "sku": "USR-01-CF09B",
                //                 "price": "10.99",
                //                 "smallImage": "https://cdn11.bigcommerce.com/s-rcvl76lfrq/products/335/images/568/USR-01-CF09B_-_STEEL_SNAPHOOK__73672.1518632778.190.285.jpg?c=2",
                //                 "currentPageUrl": "https://usrigging.com/proclimb-ansi-double-action-self-locking-steel-snap-hook/",
                //                 "badging": [],
                //                 "stock": 985
                //             },
                //             {
                //                 "name": "Forged Steel Rebar Hook w/ Fixed Eye",
                //                 "productId": "336",
                //                 "sku": "USR-BRH-C09B",
                //                 "price": "26.99",
                //                 "smallImage": "https://cdn11.bigcommerce.com/s-rcvl76lfrq/products/336/images/569/USR-BRH-C09B_-_FORGED_STEEL_REBAR_HOOK_W_EYE__53853.1518632750.190.285.jpg?c=2",
                //                 "currentPageUrl": "https://usrigging.com/proclimb-ansi-forged-steel-rebar-hook/",
                //                 "badging": [],
                //                 "stock": 220
                //             },
                //             {
                //                 "name": "Tactical Forged Steel Scaffold Ladder Hook w/ Captive Pin",
                //                 "productId": "525",
                //                 "sku": "USR-04-C09B-BK",
                //                 "price": "16.99",
                //                 "smallImage": "https://cdn11.bigcommerce.com/s-rcvl76lfrq/products/525/images/1376/USR-04-C09B-BK__69182.1518634077.190.285.jpg?c=2",
                //                 "currentPageUrl": "https://usrigging.com/twist-lock-self-locking-steel-scaffold-hook/",
                //                 "badging": [],
                //                 "stock": 335
                //             },
                //             {
                //                 "name": "1/4\" - Hot Dipped Light-Duty Galvanized Steel Wire Rope Thimbles - (SOLD IN PACKS)",
                //                 "productId": "870",
                //                 "sku": "F-15-408-Z-100K",
                //                 "price": "46.99",
                //                 "smallImage": "https://cdn11.bigcommerce.com/s-rcvl76lfrq/products/870/images/3541/F-15-408-Z-100K__24870.1623178136.190.285.png?c=2",
                //                 "currentPageUrl": "https://usrigging.com/durabrite-hot-dipped-light-duty-galvanized-steel-wire-rope-thimbles/",
                //                 "badging": [],
                //                 "stock": 71
                //             },
                //             {
                //                 "name": "Micro 900 Carabiner - Lime Green",
                //                 "productId": "1177",
                //                 "sku": "USR-109LG",
                //                 "price": "13.99",
                //                 "smallImage": "https://cdn11.bigcommerce.com/s-rcvl76lfrq/products/1177/images/485/USR-109LG__54619.1516906970.190.285.jpg?c=2",
                //                 "currentPageUrl": "https://usrigging.com/micro-900-carabiner-lime-green/",
                //                 "badging": [],
                //                 "stock": 1759
                //             },
                //             {
                //                 "name": "28 mm - Stainless Steel Rigging Ring - 52 mm O.D.",
                //                 "productId": "1183",
                //                 "sku": "USR-28-S",
                //                 "price": "13.99",
                //                 "smallImage": "https://cdn11.bigcommerce.com/s-rcvl76lfrq/products/1183/images/489/USR-28-S__95018.1522344985.190.285.jpg?c=2",
                //                 "currentPageUrl": "https://usrigging.com/28-mm-stainless-steel-rigging-ring-52-mm-o-d/",
                //                 "badging": [],
                //                 "stock": 2086
                //             },
                //             {
                //                 "name": "Forged Aluminum Eye-to-Eye Swivel",
                //                 "productId": "1189",
                //                 "sku": "USR-DSR",
                //                 "price": "37.99",
                //                 "smallImage": "https://cdn11.bigcommerce.com/s-rcvl76lfrq/products/1189/images/495/USR-DSR__51922.1516906960.190.285.jpg?c=2",
                //                 "currentPageUrl": "https://usrigging.com/forged-aluminum-eye-to-eye-swivel/",
                //                 "badging": [],
                //                 "stock": 953
                //             },
                //             {
                //                 "name": "316 Stainless Steel Tactical Fixed Eye Snap Shackles - Size #1 - (SOLD IN PACKS)",
                //                 "productId": "1544",
                //                 "sku": "K-7-1BLK",
                //                 "price": "21.49",
                //                 "smallImage": "https://cdn11.bigcommerce.com/s-rcvl76lfrq/products/1544/images/3537/K-7-1BLK__85483.1623177866.190.285.png?c=2",
                //                 "currentPageUrl": "https://usrigging.com/durabrite-316-stainless-steel-tactical-fixed-eye-snap-shackles",
                //                 "badging": [],
                //                 "stock": 1499
                //             },
                //             {
                //                 "name": "Micro 900 Carabiners - Green - (SOLD IN PACKS)",
                //                 "productId": "2153",
                //                 "sku": "USR-109LG-3K",
                //                 "price": "27.49",
                //                 "smallImage": "https://cdn11.bigcommerce.com/s-rcvl76lfrq/products/2153/images/3505/USR-109LG-3K__52616.1625070951.190.285.png?c=2",
                //                 "currentPageUrl": "https://usrigging.com/micro-900-carabiners-green-sold-in-packs/",
                //                 "badging": [],
                //                 "stock": 578
                //             },
                //             {
                //                 "name": "7x7 | Vinyl Coated Stainless Steel Wire Rope (Aircraft Cable)",
                //                 "productId": "2201",
                //                 "sku": "W-30",
                //                 "price": "65.99",
                //                 "smallImage": "https://cdn11.bigcommerce.com/s-rcvl76lfrq/products/2201/images/3549/W-30__44614.1623178591.190.285.png?c=2",
                //                 "currentPageUrl": "https://usrigging.com/7x7-vinyl-coated-stainless-steel-wire-rope-aircraft-cable/",
                //                 "variantInfo": [
                //                     {
                //                         "productId": "3545",
                //                         "discountedPrice": null,
                //                         "price": "122.99",
                //                         "name": "3/64”",
                //                         "variantId": "694",
                //                         "sku": "W-30-512-150FT",
                //                         "stock": "27.0"
                //                     },
                //                     {
                //                         "productId": "3546",
                //                         "discountedPrice": null,
                //                         "price": "65.99",
                //                         "name": "1/16”",
                //                         "variantId": "695",
                //                         "sku": "W-30-523-300FT",
                //                         "stock": "29.0"
                //                     },
                //                     {
                //                         "productId": "3547",
                //                         "discountedPrice": null,
                //                         "price": "112.99",
                //                         "name": "3/32”",
                //                         "variantId": "696",
                //                         "sku": "W-30-534-250FT",
                //                         "stock": "23.0"
                //                     },
                //                     {
                //                         "productId": "3548",
                //                         "discountedPrice": null,
                //                         "price": "244.99",
                //                         "name": "1/8”",
                //                         "variantId": "697",
                //                         "sku": "W-30-545-200FT",
                //                         "stock": "1.0"
                //                     },
                //                     {
                //                         "productId": "3549",
                //                         "discountedPrice": null,
                //                         "price": "159.99",
                //                         "name": "1/16”",
                //                         "variantId": "695",
                //                         "sku": "W-30-024-200FT",
                //                         "stock": "58.0"
                //                     },
                //                     {
                //                         "productId": "3550",
                //                         "discountedPrice": null,
                //                         "price": "214.99",
                //                         "name": "1/8”",
                //                         "variantId": "697",
                //                         "sku": "W-30-047-175FT",
                //                         "stock": "10.0"
                //                     },
                //                     {
                //                         "productId": "3551",
                //                         "discountedPrice": null,
                //                         "price": "219.99",
                //                         "name": "3/16”",
                //                         "variantId": "699",
                //                         "sku": "W-30-060-100FT",
                //                         "stock": "8.0"
                //                     }
                //                 ],
                //                 "badging": [],
                //                 "stock": 156
                //             },
                //             {
                //                 "name": "304 SS AN-100C6 Type Wire Rope Thimbles - (SOLD IN PACKS)",
                //                 "productId": "2281",
                //                 "sku": "F-15",
                //                 "price": "35.99",
                //                 "smallImage": "https://cdn11.bigcommerce.com/s-rcvl76lfrq/products/2281/images/3535/F-15__35283.1623177775.190.285.png?c=2",
                //                 "currentPageUrl": "https://usrigging.com/durabrite-304-stainless-steel-an-100c6-type-wire-rope-thimbles/",
                //                 "variantInfo": [
                //                     {
                //                         "productId": "3923",
                //                         "discountedPrice": null,
                //                         "price": "35.99",
                //                         "name": "3/64 - 1/16”",
                //                         "variantId": "723",
                //                         "sku": "F-15-002-100K",
                //                         "stock": "51.0"
                //                     },
                //                     {
                //                         "productId": "3924",
                //                         "discountedPrice": null,
                //                         "price": "34.99",
                //                         "name": "3/32 - 1/8”",
                //                         "variantId": "726",
                //                         "sku": "F-15-004-100K",
                //                         "stock": "62.0"
                //                     },
                //                     {
                //                         "productId": "3925",
                //                         "discountedPrice": null,
                //                         "price": "43.99",
                //                         "name": "5/32”",
                //                         "variantId": "728",
                //                         "sku": "F-15-005-100K",
                //                         "stock": "24.0"
                //                     },
                //                     {
                //                         "productId": "3926",
                //                         "discountedPrice": null,
                //                         "price": "59.99",
                //                         "name": "3/16”",
                //                         "variantId": "729",
                //                         "sku": "F-15-006-100K",
                //                         "stock": "40.0"
                //                     },
                //                     {
                //                         "productId": "3927",
                //                         "discountedPrice": null,
                //                         "price": "121.99",
                //                         "name": "7/32 - 1/4”",
                //                         "variantId": "730",
                //                         "sku": "F-15-008-100K",
                //                         "stock": "5.0"
                //                     },
                //                     {
                //                         "productId": "3928",
                //                         "discountedPrice": null,
                //                         "price": "119.99",
                //                         "name": "5/16”",
                //                         "variantId": "732",
                //                         "sku": "F-15-010-50K",
                //                         "stock": "7.0"
                //                     },
                //                     {
                //                         "productId": "3929",
                //                         "discountedPrice": null,
                //                         "price": "183.99",
                //                         "name": "3/8”",
                //                         "variantId": "733",
                //                         "sku": "F-15-012-50K",
                //                         "stock": "90.0"
                //                     }
                //                 ],
                //                 "badging": [],
                //                 "stock": 279
                //             },
                //             {
                //                 "name": "316 Stainless Steel Carbine Snaps - (SOLD IN PACKS)",
                //                 "productId": "2291",
                //                 "sku": "K-52",
                //                 "price": "31.99",
                //                 "smallImage": "https://cdn11.bigcommerce.com/s-rcvl76lfrq/products/2291/images/3519/K-52__93015.1623176863.190.285.png?c=2",
                //                 "currentPageUrl": "https://usrigging.com/durabrite-316-stainless-steel-carbine-snaps/",
                //                 "variantInfo": [
                //                     {
                //                         "productId": "4002",
                //                         "discountedPrice": null,
                //                         "price": "31.99",
                //                         "name": "3/16”",
                //                         "variantId": "749",
                //                         "sku": "K-52-06-20K",
                //                         "stock": "31.0"
                //                     },
                //                     {
                //                         "productId": "4003",
                //                         "discountedPrice": null,
                //                         "price": "38.99",
                //                         "name": "1/4”",
                //                         "variantId": "750",
                //                         "sku": "K-52-08-20K",
                //                         "stock": "170.0"
                //                     },
                //                     {
                //                         "productId": "4004",
                //                         "discountedPrice": null,
                //                         "price": "38.49",
                //                         "name": "5/16”",
                //                         "variantId": "751",
                //                         "sku": "K-52-10-10K",
                //                         "stock": "28.0"
                //                     },
                //                     {
                //                         "productId": "4005",
                //                         "discountedPrice": null,
                //                         "price": "41.49",
                //                         "name": "3/8”",
                //                         "variantId": "752",
                //                         "sku": "K-52-12-5K",
                //                         "stock": "90.0"
                //                     },
                //                     {
                //                         "productId": "4006",
                //                         "discountedPrice": null,
                //                         "price": "53.49",
                //                         "name": "7/16”",
                //                         "variantId": "753",
                //                         "sku": "K-52-14-5K",
                //                         "stock": "0.0"
                //                     },
                //                     {
                //                         "productId": "4007",
                //                         "discountedPrice": null,
                //                         "price": "68.49",
                //                         "name": "1/2”",
                //                         "variantId": "754",
                //                         "sku": "K-52-16-5K",
                //                         "stock": "30.0"
                //                     }
                //                 ],
                //                 "badging": [],
                //                 "stock": 349
                //             },
                //             {
                //                 "name": "316 Stainless Steel Spring Gate Snaps - (SOLD IN PACKS)",
                //                 "productId": "2292",
                //                 "sku": "K-18",
                //                 "price": "24.99",
                //                 "smallImage": "https://cdn11.bigcommerce.com/s-rcvl76lfrq/products/2292/images/3532/K-18__57407.1623177483.190.285.png?c=2",
                //                 "currentPageUrl": "https://usrigging.com/durabrite-316-stainless-steel-spring-gate-snaps/",
                //                 "variantInfo": [
                //                     {
                //                         "productId": "4013",
                //                         "discountedPrice": null,
                //                         "price": "24.99",
                //                         "name": "Small",
                //                         "variantId": "743",
                //                         "sku": "K-18-S-10K",
                //                         "stock": "224.0"
                //                     },
                //                     {
                //                         "productId": "4014",
                //                         "discountedPrice": null,
                //                         "price": "24.99",
                //                         "name": "Medium",
                //                         "variantId": "744",
                //                         "sku": "K-18-M-5K",
                //                         "stock": "56.0"
                //                     },
                //                     {
                //                         "productId": "4015",
                //                         "discountedPrice": null,
                //                         "price": "37.99",
                //                         "name": "Large",
                //                         "variantId": "745",
                //                         "sku": "K-18-L-5K",
                //                         "stock": "15.0"
                //                     }
                //                 ],
                //                 "badging": [],
                //                 "stock": 295
                //             },
                //             {
                //                 "name": "Zinc Plated Steel Carbine Snaps - (SOLD IN PACKS)",
                //                 "productId": "2295",
                //                 "sku": "LC-54",
                //                 "price": "32.99",
                //                 "smallImage": "https://cdn11.bigcommerce.com/s-rcvl76lfrq/products/2295/images/3495/LC-54__45928.1623175463.190.285.png?c=2",
                //                 "currentPageUrl": "https://usrigging.com/durabrite-zinc-plated-steel-carbine-snaps/",
                //                 "variantInfo": [
                //                     {
                //                         "productId": "4027",
                //                         "discountedPrice": null,
                //                         "price": "32.99",
                //                         "name": "3/16”",
                //                         "variantId": "749",
                //                         "sku": "LC-54-06-Z-100K",
                //                         "stock": "3.0"
                //                     },
                //                     {
                //                         "productId": "4028",
                //                         "discountedPrice": null,
                //                         "price": "37.99",
                //                         "name": "1/4”",
                //                         "variantId": "750",
                //                         "sku": "LC-54-08-Z-100K",
                //                         "stock": "320.0"
                //                     },
                //                     {
                //                         "productId": "4029",
                //                         "discountedPrice": null,
                //                         "price": "34.99",
                //                         "name": "5/16”",
                //                         "variantId": "751",
                //                         "sku": "LC-54-10-Z-50K",
                //                         "stock": "50.0"
                //                     },
                //                     {
                //                         "productId": "4030",
                //                         "discountedPrice": null,
                //                         "price": "41.99",
                //                         "name": "3/8”",
                //                         "variantId": "752",
                //                         "sku": "LC-54-12-Z-20K",
                //                         "stock": "38.0"
                //                     },
                //                     {
                //                         "productId": "4031",
                //                         "discountedPrice": null,
                //                         "price": "32.99",
                //                         "name": "1/2”",
                //                         "variantId": "754",
                //                         "sku": "LC-54-16-Z",
                //                         "stock": "156.0"
                //                     }
                //                 ],
                //                 "badging": [],
                //                 "stock": 567
                //             },
                //             {
                //                 "name": "316 Stainless Steel Fixed Eye Snap Shackles - (SOLD IN PACKS)",
                //                 "productId": "2306",
                //                 "sku": "K-7",
                //                 "price": "21.99",
                //                 "smallImage": "https://cdn11.bigcommerce.com/s-rcvl76lfrq/products/2306/images/3523/K-7__38096.1623177052.190.285.png?c=2",
                //                 "currentPageUrl": "https://usrigging.com/durabrite-316-stainless-steel-fixed-eye-snap-shackles/",
                //                 "variantInfo": [
                //                     {
                //                         "productId": "4094",
                //                         "discountedPrice": null,
                //                         "price": "21.99",
                //                         "name": "#1",
                //                         "variantId": "773",
                //                         "sku": "K-7-1-2K",
                //                         "stock": "603.0"
                //                     },
                //                     {
                //                         "productId": "4095",
                //                         "discountedPrice": null,
                //                         "price": "25.99",
                //                         "name": "#2",
                //                         "variantId": "774",
                //                         "sku": "K-7-2-2K",
                //                         "stock": "359.0"
                //                     }
                //                 ],
                //                 "badging": [],
                //                 "stock": 962
                //             },
                //             {
                //                 "name": "Zinc Plated Delta Links",
                //                 "productId": "2313",
                //                 "sku": "LC-DL",
                //                 "price": "56.99",
                //                 "smallImage": "https://cdn11.bigcommerce.com/s-rcvl76lfrq/products/2313/images/2674/LC_DL__44546.1563819586.190.285.jpg?c=2",
                //                 "currentPageUrl": "https://usrigging.com/durabrite-zinc-plated-delta-links/",
                //                 "variantInfo": [
                //                     {
                //                         "productId": "4125",
                //                         "discountedPrice": null,
                //                         "price": "56.99",
                //                         "name": "3/16”",
                //                         "variantId": "729",
                //                         "sku": "LC-DL-06Z-100K",
                //                         "stock": "0.0"
                //                     },
                //                     {
                //                         "productId": "4126",
                //                         "discountedPrice": null,
                //                         "price": "64.99",
                //                         "name": "1/4”",
                //                         "variantId": "731",
                //                         "sku": "LC-DL-08Z-100K",
                //                         "stock": "1.0"
                //                     },
                //                     {
                //                         "productId": "4127",
                //                         "discountedPrice": null,
                //                         "price": "54.99",
                //                         "name": "5/16”",
                //                         "variantId": "732",
                //                         "sku": "LC-DL-10Z-50K",
                //                         "stock": "5.0"
                //                     },
                //                     {
                //                         "productId": "4128",
                //                         "discountedPrice": null,
                //                         "price": "78.99",
                //                         "name": "3/8”",
                //                         "variantId": "733",
                //                         "sku": "LC-DL-12Z-20K",
                //                         "stock": "7.0"
                //                     }
                //                 ],
                //                 "badging": [],
                //                 "stock": 13
                //             },
                //             {
                //                 "name": "Triple Lock True Oval Aluminum Carabiner",
                //                 "productId": "1645",
                //                 "sku": "USR-127-A3TU",
                //                 "price": "18.99",
                //                 "smallImage": "https://cdn11.bigcommerce.com/s-rcvl76lfrq/products/1645/images/1079/USR-127-A3TU_-_TRUE_OVAL_ALUM_CARABINER__02931.1518483501.190.285.jpg?c=2",
                //                 "currentPageUrl": "https://usrigging.com/true-oval-aluminum-carabiner/",
                //                 "badging": [],
                //                 "stock": 244
                //             }
                //         ],
                //         "customValues": {},
                //         "productMap": null
                //     }
                // }
                data = JSON.parse(this.responseText);

                let mainWidgetId = null;
                if(data.mainWidgetId)
                mainWidgetId = data.mainWidgetId;
            
                widgetName = data.widgetname || data.widgetType;
                let customValues = data.customValues;
                data = data.docs || data.products;
                // if(window.sessionStorage.orgName === 'dubaistore' && widgetName === 'recentviews')
                // data = [
                //     {
                //         "name": "Steel Snap Hook w/ Fixed Eye",
                //         "productId": "241",
                //         "sku": "USR-01-CF07",
                //         "price": "18.49",
                //         "smallImage": "https://cdn11.bigcommerce.com/s-rcvl76lfrq/products/241/images/555/USR-01-CF07_-_STEEL_SNAP_HOOK_W_EYE__65347.1518633619.190.285.jpg?c=2",
                //         "currentPageUrl": "https://usrigging.com/proclimb-ansi-double-action-steel-snap-hook/",
                //         "badging": [],
                //         "stock": 861
                //     },
                //     {
                //         "name": "Forged Aluminum Snap Hook w/ Fixed Eye - Blue",
                //         "productId": "307",
                //         "sku": "USR-50-AB",
                //         "price": "22.49",
                //         "smallImage": "https://cdn11.bigcommerce.com/s-rcvl76lfrq/products/307/images/562/USR-50-AB_-_FORGED_ALUM_SNAPHOOK_W_EYE__98527.1518633374.190.285.jpg?c=2",
                //         "currentPageUrl": "https://usrigging.com/proclimb-aluminum-double-lock-hook/",
                //         "badging": [],
                //         "stock": 4400
                //     },
                //     {
                //         "name": "Steel Ladder Hook",
                //         "productId": "315",
                //         "sku": "USR-71-CTS",
                //         "price": "27.99",
                //         "smallImage": "https://cdn11.bigcommerce.com/s-rcvl76lfrq/products/315/images/514/USR-71-CTS_-_STEEL_LADDER_HOOK__58317.1518633343.190.285.jpg?c=2",
                //         "currentPageUrl": "https://usrigging.com/proclimb-nfpa-steel-ladder-hook-screw-lock/",
                //         "badging": [],
                //         "stock": 432
                //     },
                //     {
                //         "name": "Steel Snap Hook",
                //         "productId": "335",
                //         "sku": "USR-01-CF09B",
                //         "price": "10.99",
                //         "smallImage": "https://cdn11.bigcommerce.com/s-rcvl76lfrq/products/335/images/568/USR-01-CF09B_-_STEEL_SNAPHOOK__73672.1518632778.190.285.jpg?c=2",
                //         "currentPageUrl": "https://usrigging.com/proclimb-ansi-double-action-self-locking-steel-snap-hook/",
                //         "badging": [],
                //         "stock": 985
                //     },
                //     {
                //         "name": "Forged Steel Rebar Hook w/ Fixed Eye",
                //         "productId": "336",
                //         "sku": "USR-BRH-C09B",
                //         "price": "26.99",
                //         "smallImage": "https://cdn11.bigcommerce.com/s-rcvl76lfrq/products/336/images/569/USR-BRH-C09B_-_FORGED_STEEL_REBAR_HOOK_W_EYE__53853.1518632750.190.285.jpg?c=2",
                //         "currentPageUrl": "https://usrigging.com/proclimb-ansi-forged-steel-rebar-hook/",
                //         "badging": [],
                //         "stock": 220
                //     },
                //     {
                //         "name": "Tactical Forged Steel Scaffold Ladder Hook w/ Captive Pin",
                //         "productId": "525",
                //         "sku": "USR-04-C09B-BK",
                //         "price": "16.99",
                //         "smallImage": "https://cdn11.bigcommerce.com/s-rcvl76lfrq/products/525/images/1376/USR-04-C09B-BK__69182.1518634077.190.285.jpg?c=2",
                //         "currentPageUrl": "https://usrigging.com/twist-lock-self-locking-steel-scaffold-hook/",
                //         "badging": [],
                //         "stock": 335
                //     },
                //     {
                //         "name": "1/4\" - Hot Dipped Light-Duty Galvanized Steel Wire Rope Thimbles - (SOLD IN PACKS)",
                //         "productId": "870",
                //         "sku": "F-15-408-Z-100K",
                //         "price": "46.99",
                //         "smallImage": "https://cdn11.bigcommerce.com/s-rcvl76lfrq/products/870/images/3541/F-15-408-Z-100K__24870.1623178136.190.285.png?c=2",
                //         "currentPageUrl": "https://usrigging.com/durabrite-hot-dipped-light-duty-galvanized-steel-wire-rope-thimbles/",
                //         "badging": [],
                //         "stock": 71
                //     },
                //     {
                //         "name": "Micro 900 Carabiner - Lime Green",
                //         "productId": "1177",
                //         "sku": "USR-109LG",
                //         "price": "13.99",
                //         "smallImage": "https://cdn11.bigcommerce.com/s-rcvl76lfrq/products/1177/images/485/USR-109LG__54619.1516906970.190.285.jpg?c=2",
                //         "currentPageUrl": "https://usrigging.com/micro-900-carabiner-lime-green/",
                //         "badging": [],
                //         "stock": 1759
                //     },
                //     {
                //         "name": "28 mm - Stainless Steel Rigging Ring - 52 mm O.D.",
                //         "productId": "1183",
                //         "sku": "USR-28-S",
                //         "price": "13.99",
                //         "smallImage": "https://cdn11.bigcommerce.com/s-rcvl76lfrq/products/1183/images/489/USR-28-S__95018.1522344985.190.285.jpg?c=2",
                //         "currentPageUrl": "https://usrigging.com/28-mm-stainless-steel-rigging-ring-52-mm-o-d/",
                //         "badging": [],
                //         "stock": 2086
                //     },
                //     {
                //         "name": "Forged Aluminum Eye-to-Eye Swivel",
                //         "productId": "1189",
                //         "sku": "USR-DSR",
                //         "price": "37.99",
                //         "smallImage": "https://cdn11.bigcommerce.com/s-rcvl76lfrq/products/1189/images/495/USR-DSR__51922.1516906960.190.285.jpg?c=2",
                //         "currentPageUrl": "https://usrigging.com/forged-aluminum-eye-to-eye-swivel/",
                //         "badging": [],
                //         "stock": 953
                //     },
                //     {
                //         "name": "316 Stainless Steel Tactical Fixed Eye Snap Shackles - Size #1 - (SOLD IN PACKS)",
                //         "productId": "1544",
                //         "sku": "K-7-1BLK",
                //         "price": "21.49",
                //         "smallImage": "https://cdn11.bigcommerce.com/s-rcvl76lfrq/products/1544/images/3537/K-7-1BLK__85483.1623177866.190.285.png?c=2",
                //         "currentPageUrl": "https://usrigging.com/durabrite-316-stainless-steel-tactical-fixed-eye-snap-shackles",
                //         "badging": [],
                //         "stock": 1499
                //     },
                //     {
                //         "name": "Micro 900 Carabiners - Green - (SOLD IN PACKS)",
                //         "productId": "2153",
                //         "sku": "USR-109LG-3K",
                //         "price": "27.49",
                //         "smallImage": "https://cdn11.bigcommerce.com/s-rcvl76lfrq/products/2153/images/3505/USR-109LG-3K__52616.1625070951.190.285.png?c=2",
                //         "currentPageUrl": "https://usrigging.com/micro-900-carabiners-green-sold-in-packs/",
                //         "badging": [],
                //         "stock": 578
                //     },
                //     {
                //         "name": "7x7 | Vinyl Coated Stainless Steel Wire Rope (Aircraft Cable)",
                //         "productId": "2201",
                //         "sku": "W-30",
                //         "price": "65.99",
                //         "smallImage": "https://cdn11.bigcommerce.com/s-rcvl76lfrq/products/2201/images/3549/W-30__44614.1623178591.190.285.png?c=2",
                //         "currentPageUrl": "https://usrigging.com/7x7-vinyl-coated-stainless-steel-wire-rope-aircraft-cable/",
                //         "variantInfo": [
                //             {
                //                 "productId": "3545",
                //                 "discountedPrice": null,
                //                 "price": "122.99",
                //                 "name": "3/64”",
                //                 "variantId": "694",
                //                 "sku": "W-30-512-150FT",
                //                 "stock": "27.0"
                //             },
                //             {
                //                 "productId": "3546",
                //                 "discountedPrice": null,
                //                 "price": "65.99",
                //                 "name": "1/16”",
                //                 "variantId": "695",
                //                 "sku": "W-30-523-300FT",
                //                 "stock": "29.0"
                //             },
                //             {
                //                 "productId": "3547",
                //                 "discountedPrice": null,
                //                 "price": "112.99",
                //                 "name": "3/32”",
                //                 "variantId": "696",
                //                 "sku": "W-30-534-250FT",
                //                 "stock": "23.0"
                //             },
                //             {
                //                 "productId": "3548",
                //                 "discountedPrice": null,
                //                 "price": "244.99",
                //                 "name": "1/8”",
                //                 "variantId": "697",
                //                 "sku": "W-30-545-200FT",
                //                 "stock": "1.0"
                //             },
                //             {
                //                 "productId": "3549",
                //                 "discountedPrice": null,
                //                 "price": "159.99",
                //                 "name": "1/16”",
                //                 "variantId": "695",
                //                 "sku": "W-30-024-200FT",
                //                 "stock": "58.0"
                //             },
                //             {
                //                 "productId": "3550",
                //                 "discountedPrice": null,
                //                 "price": "214.99",
                //                 "name": "1/8”",
                //                 "variantId": "697",
                //                 "sku": "W-30-047-175FT",
                //                 "stock": "10.0"
                //             },
                //             {
                //                 "productId": "3551",
                //                 "discountedPrice": null,
                //                 "price": "219.99",
                //                 "name": "3/16”",
                //                 "variantId": "699",
                //                 "sku": "W-30-060-100FT",
                //                 "stock": "8.0"
                //             }
                //         ],
                //         "badging": [],
                //         "stock": 156
                //     },
                //     {
                //         "name": "304 SS AN-100C6 Type Wire Rope Thimbles - (SOLD IN PACKS)",
                //         "productId": "2281",
                //         "sku": "F-15",
                //         "price": "35.99",
                //         "smallImage": "https://cdn11.bigcommerce.com/s-rcvl76lfrq/products/2281/images/3535/F-15__35283.1623177775.190.285.png?c=2",
                //         "currentPageUrl": "https://usrigging.com/durabrite-304-stainless-steel-an-100c6-type-wire-rope-thimbles/",
                //         "variantInfo": [
                //             {
                //                 "productId": "3923",
                //                 "discountedPrice": null,
                //                 "price": "35.99",
                //                 "name": "3/64 - 1/16”",
                //                 "variantId": "723",
                //                 "sku": "F-15-002-100K",
                //                 "stock": "51.0"
                //             },
                //             {
                //                 "productId": "3924",
                //                 "discountedPrice": null,
                //                 "price": "34.99",
                //                 "name": "3/32 - 1/8”",
                //                 "variantId": "726",
                //                 "sku": "F-15-004-100K",
                //                 "stock": "62.0"
                //             },
                //             {
                //                 "productId": "3925",
                //                 "discountedPrice": null,
                //                 "price": "43.99",
                //                 "name": "5/32”",
                //                 "variantId": "728",
                //                 "sku": "F-15-005-100K",
                //                 "stock": "24.0"
                //             },
                //             {
                //                 "productId": "3926",
                //                 "discountedPrice": null,
                //                 "price": "59.99",
                //                 "name": "3/16”",
                //                 "variantId": "729",
                //                 "sku": "F-15-006-100K",
                //                 "stock": "40.0"
                //             },
                //             {
                //                 "productId": "3927",
                //                 "discountedPrice": null,
                //                 "price": "121.99",
                //                 "name": "7/32 - 1/4”",
                //                 "variantId": "730",
                //                 "sku": "F-15-008-100K",
                //                 "stock": "5.0"
                //             },
                //             {
                //                 "productId": "3928",
                //                 "discountedPrice": null,
                //                 "price": "119.99",
                //                 "name": "5/16”",
                //                 "variantId": "732",
                //                 "sku": "F-15-010-50K",
                //                 "stock": "7.0"
                //             },
                //             {
                //                 "productId": "3929",
                //                 "discountedPrice": null,
                //                 "price": "183.99",
                //                 "name": "3/8”",
                //                 "variantId": "733",
                //                 "sku": "F-15-012-50K",
                //                 "stock": "90.0"
                //             }
                //         ],
                //         "badging": [],
                //         "stock": 279
                //     },
                //     {
                //         "name": "316 Stainless Steel Carbine Snaps - (SOLD IN PACKS)",
                //         "productId": "2291",
                //         "sku": "K-52",
                //         "price": "31.99",
                //         "smallImage": "https://cdn11.bigcommerce.com/s-rcvl76lfrq/products/2291/images/3519/K-52__93015.1623176863.190.285.png?c=2",
                //         "currentPageUrl": "https://usrigging.com/durabrite-316-stainless-steel-carbine-snaps/",
                //         "variantInfo": [
                //             {
                //                 "productId": "4002",
                //                 "discountedPrice": null,
                //                 "price": "31.99",
                //                 "name": "3/16”",
                //                 "variantId": "749",
                //                 "sku": "K-52-06-20K",
                //                 "stock": "31.0"
                //             },
                //             {
                //                 "productId": "4003",
                //                 "discountedPrice": null,
                //                 "price": "38.99",
                //                 "name": "1/4”",
                //                 "variantId": "750",
                //                 "sku": "K-52-08-20K",
                //                 "stock": "170.0"
                //             },
                //             {
                //                 "productId": "4004",
                //                 "discountedPrice": null,
                //                 "price": "38.49",
                //                 "name": "5/16”",
                //                 "variantId": "751",
                //                 "sku": "K-52-10-10K",
                //                 "stock": "28.0"
                //             },
                //             {
                //                 "productId": "4005",
                //                 "discountedPrice": null,
                //                 "price": "41.49",
                //                 "name": "3/8”",
                //                 "variantId": "752",
                //                 "sku": "K-52-12-5K",
                //                 "stock": "90.0"
                //             },
                //             {
                //                 "productId": "4006",
                //                 "discountedPrice": null,
                //                 "price": "53.49",
                //                 "name": "7/16”",
                //                 "variantId": "753",
                //                 "sku": "K-52-14-5K",
                //                 "stock": "0.0"
                //             },
                //             {
                //                 "productId": "4007",
                //                 "discountedPrice": null,
                //                 "price": "68.49",
                //                 "name": "1/2”",
                //                 "variantId": "754",
                //                 "sku": "K-52-16-5K",
                //                 "stock": "30.0"
                //             }
                //         ],
                //         "badging": [],
                //         "stock": 349
                //     },
                //     {
                //         "name": "316 Stainless Steel Spring Gate Snaps - (SOLD IN PACKS)",
                //         "productId": "2292",
                //         "sku": "K-18",
                //         "price": "24.99",
                //         "smallImage": "https://cdn11.bigcommerce.com/s-rcvl76lfrq/products/2292/images/3532/K-18__57407.1623177483.190.285.png?c=2",
                //         "currentPageUrl": "https://usrigging.com/durabrite-316-stainless-steel-spring-gate-snaps/",
                //         "variantInfo": [
                //             {
                //                 "productId": "4013",
                //                 "discountedPrice": null,
                //                 "price": "24.99",
                //                 "name": "Small",
                //                 "variantId": "743",
                //                 "sku": "K-18-S-10K",
                //                 "stock": "224.0"
                //             },
                //             {
                //                 "productId": "4014",
                //                 "discountedPrice": null,
                //                 "price": "24.99",
                //                 "name": "Medium",
                //                 "variantId": "744",
                //                 "sku": "K-18-M-5K",
                //                 "stock": "56.0"
                //             },
                //             {
                //                 "productId": "4015",
                //                 "discountedPrice": null,
                //                 "price": "37.99",
                //                 "name": "Large",
                //                 "variantId": "745",
                //                 "sku": "K-18-L-5K",
                //                 "stock": "15.0"
                //             }
                //         ],
                //         "badging": [],
                //         "stock": 295
                //     },
                //     {
                //         "name": "Zinc Plated Steel Carbine Snaps - (SOLD IN PACKS)",
                //         "productId": "2295",
                //         "sku": "LC-54",
                //         "price": "32.99",
                //         "smallImage": "https://cdn11.bigcommerce.com/s-rcvl76lfrq/products/2295/images/3495/LC-54__45928.1623175463.190.285.png?c=2",
                //         "currentPageUrl": "https://usrigging.com/durabrite-zinc-plated-steel-carbine-snaps/",
                //         "variantInfo": [
                //             {
                //                 "productId": "4027",
                //                 "discountedPrice": null,
                //                 "price": "32.99",
                //                 "name": "3/16”",
                //                 "variantId": "749",
                //                 "sku": "LC-54-06-Z-100K",
                //                 "stock": "3.0"
                //             },
                //             {
                //                 "productId": "4028",
                //                 "discountedPrice": null,
                //                 "price": "37.99",
                //                 "name": "1/4”",
                //                 "variantId": "750",
                //                 "sku": "LC-54-08-Z-100K",
                //                 "stock": "320.0"
                //             },
                //             {
                //                 "productId": "4029",
                //                 "discountedPrice": null,
                //                 "price": "34.99",
                //                 "name": "5/16”",
                //                 "variantId": "751",
                //                 "sku": "LC-54-10-Z-50K",
                //                 "stock": "50.0"
                //             },
                //             {
                //                 "productId": "4030",
                //                 "discountedPrice": null,
                //                 "price": "41.99",
                //                 "name": "3/8”",
                //                 "variantId": "752",
                //                 "sku": "LC-54-12-Z-20K",
                //                 "stock": "38.0"
                //             },
                //             {
                //                 "productId": "4031",
                //                 "discountedPrice": null,
                //                 "price": "32.99",
                //                 "name": "1/2”",
                //                 "variantId": "754",
                //                 "sku": "LC-54-16-Z",
                //                 "stock": "156.0"
                //             }
                //         ],
                //         "badging": [],
                //         "stock": 567
                //     },
                //     {
                //         "name": "316 Stainless Steel Fixed Eye Snap Shackles - (SOLD IN PACKS)",
                //         "productId": "2306",
                //         "sku": "K-7",
                //         "price": "21.99",
                //         "smallImage": "https://cdn11.bigcommerce.com/s-rcvl76lfrq/products/2306/images/3523/K-7__38096.1623177052.190.285.png?c=2",
                //         "currentPageUrl": "https://usrigging.com/durabrite-316-stainless-steel-fixed-eye-snap-shackles/",
                //         "variantInfo": [
                //             {
                //                 "productId": "4094",
                //                 "discountedPrice": null,
                //                 "price": "21.99",
                //                 "name": "#1",
                //                 "variantId": "773",
                //                 "sku": "K-7-1-2K",
                //                 "stock": "603.0"
                //             },
                //             {
                //                 "productId": "4095",
                //                 "discountedPrice": null,
                //                 "price": "25.99",
                //                 "name": "#2",
                //                 "variantId": "774",
                //                 "sku": "K-7-2-2K",
                //                 "stock": "359.0"
                //             }
                //         ],
                //         "badging": [],
                //         "stock": 962
                //     },
                //     {
                //         "name": "Zinc Plated Delta Links",
                //         "productId": "2313",
                //         "sku": "LC-DL",
                //         "price": "56.99",
                //         "smallImage": "https://cdn11.bigcommerce.com/s-rcvl76lfrq/products/2313/images/2674/LC_DL__44546.1563819586.190.285.jpg?c=2",
                //         "currentPageUrl": "https://usrigging.com/durabrite-zinc-plated-delta-links/",
                //         "variantInfo": [
                //             {
                //                 "productId": "4125",
                //                 "discountedPrice": null,
                //                 "price": "56.99",
                //                 "name": "3/16”",
                //                 "variantId": "729",
                //                 "sku": "LC-DL-06Z-100K",
                //                 "stock": "0.0"
                //             },
                //             {
                //                 "productId": "4126",
                //                 "discountedPrice": null,
                //                 "price": "64.99",
                //                 "name": "1/4”",
                //                 "variantId": "731",
                //                 "sku": "LC-DL-08Z-100K",
                //                 "stock": "1.0"
                //             },
                //             {
                //                 "productId": "4127",
                //                 "discountedPrice": null,
                //                 "price": "54.99",
                //                 "name": "5/16”",
                //                 "variantId": "732",
                //                 "sku": "LC-DL-10Z-50K",
                //                 "stock": "5.0"
                //             },
                //             {
                //                 "productId": "4128",
                //                 "discountedPrice": null,
                //                 "price": "78.99",
                //                 "name": "3/8”",
                //                 "variantId": "733",
                //                 "sku": "LC-DL-12Z-20K",
                //                 "stock": "7.0"
                //             }
                //         ],
                //         "badging": [],
                //         "stock": 13
                //     },
                //     {
                //         "name": "Triple Lock True Oval Aluminum Carabiner",
                //         "productId": "1645",
                //         "sku": "USR-127-A3TU",
                //         "price": "18.99",
                //         "smallImage": "https://cdn11.bigcommerce.com/s-rcvl76lfrq/products/1645/images/1079/USR-127-A3TU_-_TRUE_OVAL_ALUM_CARABINER__02931.1518483501.190.285.jpg?c=2",
                //         "currentPageUrl": "https://usrigging.com/true-oval-aluminum-carabiner/",
                //         "badging": [],
                //         "stock": 244
                //     }
                // ]

                 if (!data || data.length == 0){
                    if(document.getElementById(type))
                    document.getElementById(type).style.cssText = "height:0";
                    return;
                } 
                
                if(!spotdyEventsConfigData.widgetStatus[type].widgetLayout){
                    var displayName = spotdyEventsConfigData.widgetStatus[type].displayName;
                    spotdyEventsConfigData.widgetStatus[type]["widgetLayout"] = JSON.parse('{"outer":{"recommendationTitle":"'+displayName+'","width":"100%","height":200,"spacingTop":20,"spacingBottom":20,"spacingLeft":10,"spacingRight":10,"productDivWidth":240,"imageDivHeight":170,"imageDivPadding":"0","productNameDivHeight":15,"productNameDivPadding":"0","productNameDivtextAlign":"center","priceDivHeight":15,"priceDivPadding":"0","priceDivtextAlign":"center"},"inner":{"maxAmount":10,"minAmount":""},"font":{"header":{"fontSize":14,"fontFamily":"Times New Roman","fontWeight":600},"product":{"fontSize":14,"fontFamily":"Times New Roman","fontWeight":600}},"color":{"headerTextColor":"black","headerBackgroundColor":"#ffffff","headerBottomColor":"#ffffff","productItemBackgroundColor":"#ffffff","productBrandColor":"black","productTextColor":"black","priceTextColor":"red","discountedPriceTextColor":"red"},"mobile":{"mobileView":true},"product":{"showHeadingtext":true,"headingTextAlign":"left","truncateProductAfterTitle":"left","productTextAlign":"left","showrating":false,"showReviewsCount":false,"currency":"$"}}');
                }
                
                data = refactorCartupPriceData(data,mainWidgetId);

                allSpotdyWidgetData[type]["data"] = data;
                var currencyPattern = JSON.parse(spotdyEventsConfigData.currentPattern);
                
                var recoType = "products";
                if(spotdyEventsConfigData.widgetStatus[type].algoName === 'Generic recommendation' && cartUpPageType === 'ProductPage')
                    spotdyEventsConfigData.widgetStatus[type].recoType = 'products.categoryListing';

                if(spotdyEventsConfigData.widgetStatus[type].recoType){
                    recoType = spotdyEventsConfigData.widgetStatus[type].recoType;
                }
                
                cartupRetries(300, 10, function(){
                    
                    var languageCookie = "";
                    if(currencyPattern.languageCookie){
                        languageCookie = getCookiesFromStorage(currencyPattern.languageCookie);
                        if(window.location.host === 'www.stg-ds.com')
                        currencyPattern.widgetTitleSettings = [{"ds_lang":"ar","widgettype":"Staging_pdp_content_based","title":"منتجات مماثلة"}, {"ds_lang":"ar","widgettype":"Staging_pdp_viewedAlsoViewed","title":"الزبائن الذين شاهدوا هذا المنتج شاهدوا أيضا"}, {"ds_lang":"ar","widgettype":"Staging_home_browser_history","title":"مُقترحة لك"}, {"ds_lang":"ar","widgettype":"Staging_home_trending","title":"العروض الشائعة"}, {"ds_lang":"ar","widgettype":"Staging_pdp_crossSell","title":"يتم شراؤها معًا"}];
                        
                        if(window.location.host === 'www.dubaistore.com' || window.location.host === 'www.stg-ds.com')
                        currencyPattern.widgetTitleSettings = [{"ds_lang":"ar","widgettype":"contenwidget_dubai","title":"منتجات مماثلة"}, {"ds_lang":"ar","widgettype":"VAV_dubai","title":"الزبائن الذين شاهدوا هذا المنتج شاهدوا أيضا"}, {"ds_lang":"ar","widgettype":"browsinghistory_dubai","title":"مُقترحة لك"}, {"ds_lang":"ar","widgettype":"home_trending_car","title":"العروض الشائعة"}, {"ds_lang":"ar","widgettype":"PDP_cross_car_dubaistore","title":"يتم شراؤها معًا"}];

                        if(currencyPattern.widgetTitleSettings){
                            var widgetTitleSettings = currencyPattern.widgetTitleSettings;
                            
                            if(widgetTitleSettings.length>0){
                                for(var i=0;i<widgetTitleSettings.length;i++){
                                    if(widgetTitleSettings[i].ds_lang === 'ar' && languageCookie === 'ar'){
                                        //if(type === widgetTitleSettings[i].widgettype){
                                            widgetTitle = widgetTitleSettings[i].title;
                                            if(spotdyEventsConfigData.widgetStatus[widgetTitleSettings[i].widgettype])
                                            spotdyEventsConfigData.widgetStatus[widgetTitleSettings[i].widgettype].displayName = widgetTitle;
                                        //}
                                    }
                                }
                            }
                        }
                        // if(languageCookie === 'ar'){
                        //     spotdyEventsConfigData.widgetStatus[type].displayName = "المزيد من هذا القبيل";
                        // }
                    }
                    
                    return showCartupCustomTheme(type, allSpotdyWidgetData[type].element, data, 
                        spotdyEventsConfigData.widgetStatus[type].displayName, 
                        allSpotdyWidgetData[type].isDomBased, allSpotdyWidgetData[type].position, customValues, recoType);
                });
                sendWidgetLoadEvent(type,mainWidgetId);
            } catch (err) {}
        }
    };
   // urlToGetTheDataForWidget = encodeURI(urlToGetTheDataForWidget);
    // xhttp.open("GET", urlToGetTheDataForWidget, true);
    // xhttp.send();
    
    xhttp.open("POST", urlToGetTheDataForWidgetAPI, true);
    xhttp.setRequestHeader("Content-Type", "application/json");
    xhttp.send(JSON.stringify(payloadObj));
    return true;
};

function getCartupProductSku() {
    
    if(!cartUpPageType){
        if(!cartUpPageType && window.sessionStorage.cartupPageMeta){
            config = JSON.parse(window.sessionStorage.cartupPageMeta)
            for(var key in config) {
                let obj = config[key].pageMeta;
                let cssSelector = obj.cssSelector.info;
                let metaInfo = obj.metaInfo.info;
                if(GetCartupCssSelectorNode(document, cssSelector) || IsCartupMetaMatching(metaInfo) || isUrlMatching(obj.urlInfo.pageUrl)){
                    cartUpPageType = key;
                    window.sessionStorage.cartupPageType = key;
                }
            }
        }else{
            cartUpPageType = window.sessionStorage.cartupPageType;
        }
    }
    if(cartUpPageType)
    if(cartUpPageType.toLowerCase() == "cartpage"){
        var element = GetCartupCssSelectorNode(document, spotdyEventsConfigData?.productInfo?.multipleSku?.cssSelector);
        if(!element) return "";
        var skuArr = [];
                        if(element.tagName === 'META'){
                            
                            let metasEle = document.getElementsByTagName('meta');
                            for (let i = 0; i < metasEle.length; i++) {
                                if (metasEle[i].getAttribute('name') === element.getAttribute('name')) {
                                    if(metasEle[i].getAttribute('content')){
                                        var getStr = (metasEle[i].getAttribute('content')).replace('Artikelnummer:','');
                                            getStr = getStr.replace('-000','');
                                            skuArr.push(getStr)
                                        //skuArr.push(metasEle[i].getAttribute('content'));
                                    }
                                }
                            }
                        }else{
                            if(!element.length){
                                if(element.className)
                                if(document.getElementsByClassName(element.className).length>0)
                                element = document.getElementsByClassName(element.className)
                                for(var i=0;i<element.length;i++){
                                    if(element[i].content){
                                        if(element[i].content){
                                            var getStr = (element[i].content).replace('Artikelnummer:','');
                                            getStr = getStr.replace('-000','').trim();
                                            skuArr.push(getStr)
                                        }
                                    }
                                    else
                                    if(element[i].innerText){
                                        var getStr = (element[i].innerText).replace('Artikelnummer:','');
                                        getStr = getStr.replace('-000','').trim();
                                        skuArr.push(getStr)
                                    }
                                }
                            }else{
                                for(var i=0;i<element.length;i++){
                                    if(element[i].content){
                                        if(element[i].content){
                                            var getStr = (element[i].content).replace('Artikelnummer:','');
                                            getStr = getStr.replace('-000','').trim();
                                            skuArr.push(getStr)
                                        }
                                    }
                                    else
                                    if(element[i].innerText){
                                        var getStr = (element[i].innerText).replace('Artikelnummer:','');
                                        getStr = getStr.replace('-000','').trim();
                                        skuArr.push(getStr)
                                    }
                                }
                            }
                        }
                        if(skuArr.length>0)
                        return skuArr;
    }else{
        var element = GetCartupCssSelectorNode(document, spotdyEventsConfigData?.productInfo?.sku?.cssSelector);
        if(!element) {
            element = GetCartupCssSelectorNode(document, spotdyEventsConfigData?.productInfo?.sku?.metaInfo);
        }
        if(!element) return "";
        return element.getAttribute("content") || element.value || element.innerText || null;
    }
}

function getCartupProductPName() {
    var element = GetCartupCssSelectorNode(document, spotdyEventsConfigData?.productInfo?.productName?.cssSelector);
    if(!element) return "";
    return element.getAttribute("content") || element.value || element.innerText || null;
}

function getCookiesFromStorage(name){
    let cookie = {};
  document.cookie.split(';').forEach(function(el) {
    let split = el.split('=');
    cookie[split[0].trim()] = split.slice(1).join("=");
  })
  return cookie[name];
}

function listenCookieChange(callback, interval = 1000) {
    let lastCookie = document.cookie;
    setInterval(()=> {
      let cookie = document.cookie;
      if (cookie !== lastCookie) {
        try {
          callback({oldValue: lastCookie, newValue: cookie});
        } finally {
          lastCookie = cookie;
        }
      }
    }, interval);
  }

function getCartupRefactoredprice(price, currencyPattern) {

    var currencyValue = currencyPattern.currency;

    var countryCookie = "";
    if(currencyPattern.countryCookie){
        countryCookie = getCookiesFromStorage(currencyPattern.countryCookie);
        if(countryCookie === 'AE')
            currencyValue = "AED";
        if(countryCookie === 'KW')
            currencyValue = "KWD";
    }

    

    

    var toFixedDigit = 0
    let seperator = currencyPattern.seperator;
    var applySpace = " ";
    if(currencyPattern.toFixed)
    toFixedDigit = currencyPattern.toFixed;
    if(currencyPattern.afterCurrencySpace)
    applySpace = currencyPattern.afterCurrencySpace;
    if(currencyPattern.afterCurrencySpace === "")
    applySpace = currencyPattern.afterCurrencySpace;
    //boxeer price formatting
    var seperator1,seperator2,seperator3,seperator4;
    if(currencyPattern.seperator1)
        seperator1 = currencyPattern.seperator1;
    if(currencyPattern.seperator2)
        seperator2 = currencyPattern.seperator2;
    if(currencyPattern.seperator3)
        seperator3 = currencyPattern.seperator3;
    if(currencyPattern.seperator4)
        seperator4 = currencyPattern.seperator4;
    
    if(currencyPattern.seperator1 || currencyPattern.seperator2 || currencyPattern.seperator3){
        var getPrice = parseFloat(price);
        if(getPrice < 100){
            if(price.includes('.')){
                price = price.replace('.',seperator);
            }else{
                price = price+seperator1+seperator2;
            }
          }
          else{
            if(getPrice >= 100 && getPrice < 1000)
            price = price+seperator1+seperator2;
          }

          if((getPrice) >= 1000){
            price = getPrice/1000;
            price = price.toFixed(toFixedDigit);
            price = price+seperator1+seperator2;
          }
          if(getPrice >= 100 && getPrice < 1000){
            if(price.includes('.')){
              price = price.replace('.',seperator);
              price = price.replace(',-',seperator3);
            }
          }

          //end boxeer price formatting
    }else{
        //if(!price.includes("."))
        price = parseFloat(price).toFixed(toFixedDigit);
        price = price.split(".").join(seperator);
    }
    
    if(isNaN(price))
        return "";
    else{
        if(currencyPattern.seperator4 && (parseFloat(price)) >= 1000){
            
            // price = parseFloat(price)/1000;
            // getPrice = price.toString().replace('.',"");
            // getPrice = getPrice/100;
            // getPrice = [getPrice.toString().slice(0, 1), getPrice.toString().slice(1)].join(currencyPattern.seperator4);
            price = [price.toString().slice(0, 1), price.toString().slice(1)].join(currencyPattern.seperator4);
            //price = getPrice;
        }
        return getCartupCurrencySymbol(currencyValue) + applySpace + price;
    }
       
}

function getCartupCurrencySymbol(currency) {
    if(currency == "euro"){
        currency = "Ã¢â€šÂ¬";
    }else if(currency == 'pound'){
        currency = "Ã‚Â£"
    }else if(currency == 'dollar'){
        currency = "$"
    }
    return currency;
}

function refactorCartupPriceData(data,mainWidgetId) {
    if(!spotdyEventsConfigData.currentPattern){
        var currencyPattern = {
            "currency": "dollar",
            "seperator": ".",
            "toFixed": "2",
            "afterCurrencySpace":" "
        };
    }else{
        var currencyPattern = JSON.parse(spotdyEventsConfigData.currentPattern);
    }
    //let currencyPattern = JSON.parse(spotdyEventsConfigData.currentPattern);
    for(let index = 0; index < data.length; index++){
        if(window.location.host === 'www.stg-ds.com')
        data[index].currentPageUrl = (data[index].currentPageUrl).replace('dubaistore','stg-ds');

        data[index]["nodiscountPrice"] = "";

        if((!data[index]["price"] || data[index]["price"] === "" || parseFloat(data[index]["price"]) === 0) && parseFloat(data[index]["discountedPrice"])>0){
            data[index]["price"] = data[index]["discountedPrice"];
        }

        data[index]["price"] = getCartupRefactoredprice(data[index]["price"], currencyPattern);
        if(!data[index]["discountedPrice"] || ["0", "0.0"].includes(data[index]["discountedPrice"]) || data[index]["discountedPrice"] == null || data[index]["discountedPrice"] == '' || data[index]["discountedPrice"] == 0){
            data[index]["discountedPrice"] = "";
        } else {
            data[index]["discountedPrice"] = getCartupRefactoredprice(data[index]["discountedPrice"], currencyPattern);
            
        }
        if(!data[index]["discountedPrice"]){
            data[index]["nodiscountPrice"] = data[index]["price"];
            data[index]["price"] = "";
        }
        if(data[index]["discountedPrice"] == data[index]["price"]){
            data[index]["discountedPrice"] = "";
            if(data[index]["price"] != '')
            data[index]["nodiscountPrice"] = data[index]["price"];
            data[index]["price"] = "";
        }
        
        
    }
    if(mainWidgetId)
        data.mainWidgetId = mainWidgetId;
    return data; 
}

function sendWidgetLoadEvent(widget_id,mainWidgetId){
    var spotdyData = {properties : {}};
    spotdySession = window.sessionStorage.sessionId;
    spotdySession = JSON.parse(spotdySession);
    spotdyData.properties["date"] = {"type" : "ISO_DATE","value" : new Date().toISOString() };
    if(generateUUID())
    spotdyData.properties["spotdy_eventid"] = {"value":generateUUID().toString(),"type":"string"};
    spotdyData.properties["currentPageUrl"] = {"type": "string" , "value" :window.location.href.toString()};
    if(spotdySession.id)
    spotdyData.properties["spotdySessionId"] = {"type" : "string","value": spotdySession.id.toString()};
    // if(widget_id)
    // spotdyData.properties["widgetId"] = {"type" : "string","value":widget_id.toString()};

    if(mainWidgetId)
        spotdyData.properties["widgetId"] = {"type" : "string","value":mainWidgetId.toString()};
    else{
        if(widget_id)
            spotdyData.properties["widgetId"] = {"type" : "string","value":widget_id.toString()};
    }


    for(var key in otherSpotdyData){
        spotdyData.properties[key] = otherSpotdyData[key];
    }
    spotdyData.properties["spotdy_eventname"] = {"value" : "__ecomtics_widget_load","type" : "string"};
    spotdyData.properties["eventType"] = {"value" : "widgetLoad","type" : "string"};
    for(var key in spotdyData.properties)
        if(spotdyData.properties[key].value === "" || spotdyData.properties[key].value === undefined)
            delete spotdyData.properties[key];
    var url = urlToSendDataToServer + encodeURIComponent(JSON.stringify(spotdyData))+ "&type=clickstream.events";
    var xhttp = spotdyGetXmlHttpObject();
    xhttp.open("GET", url, true);
    xhttp.send();
}

function sendWidgetClickEvent(sku, widget_id, product_name,proUrl,e,mainwidget_id){
    var spotdyData = {properties : {}};
    spotdySession = window.sessionStorage.sessionId;
    spotdySession = JSON.parse(spotdySession);
    if(sku)
        spotdyData.properties["sku"] = {"type":"string","value":sku.toString()};
    if(product_name)
        spotdyData.properties["product_name"] = {"type":"string","value":product_name.toString()};
    spotdyData.properties["date"] = {"type" : "ISO_DATE","value" : new Date().toISOString() };
    if(generateUUID())
    spotdyData.properties["spotdy_eventid"] = {"value":generateUUID().toString(),"type":"string"};
    spotdyData.properties["currentPageUrl"] = {"type": "string" , "value" :window.location.href.toString()};
    if(spotdySession.id)
    spotdyData.properties["spotdySessionId"] = {"type" : "string","value": spotdySession.id.toString()};
    // if(widget_id)
    // spotdyData.properties["widgetId"] = {"type" : "string","value":widget_id.toString()};
    if(mainwidget_id)
        spotdyData.properties["widgetId"] = {"type" : "string","value":mainwidget_id.toString()};
    else{
        if(widget_id)
            spotdyData.properties["widgetId"] = {"type" : "string","value":widget_id.toString()};
    }

    for(var key in otherSpotdyData){
        spotdyData.properties[key] = otherSpotdyData[key];
    }
    spotdyData.properties["spotdy_eventname"] = {"value" : "__ecomtics_widget_click","type" : "string"};
    spotdyData.properties["eventType"] = {"value" : "widgetClick","type" : "string"};
    for(var key in spotdyData.properties)
        if(spotdyData.properties[key].value === "" || spotdyData.properties[key].value === undefined)
            delete spotdyData.properties[key];
    var url = urlToSendDataToServer + encodeURIComponent(JSON.stringify(spotdyData))+ "&type=clickstream.events";
    var xhttp = spotdyGetXmlHttpObject();
    
    xhttp.onreadystatechange = function () {
        if (xhttp.readyState == 4 && xhttp.status == 200) {
            var a = e.target || e;
            var els = [];
            while (a) {
                els.unshift(a);
                a = a.parentNode;
                if(a && (a.nodeName == "A" || (e.target || e).nodeName == "A"))
                    window.location = proUrl
            }
        }
    };
    xhttp.open("GET", url, true);
    xhttp.send();
}

// function sendSearchBarEnterEvent(searchedKeyword,e){
//     var spotdyData = {properties : {}};
//     spotdySession = window.sessionStorage.sessionId;
//     spotdySession = JSON.parse(spotdySession);
//     if(searchedKeyword)
//         spotdyData.properties["keyword"] = {"type":"string","value":searchedKeyword};

//     spotdyData.properties["date"] = {"type" : "ISO_DATE","value" : new Date().toISOString() };
//     spotdyData.properties["spotdy_eventid"] = {"value":generateUUID(),"type":"string"};
//     spotdyData.properties["currentPageUrl"] = {"type": "string" , "value" :window.location.href};
//     spotdyData.properties["spotdySessionId"] = {"type" : "string","value": spotdySession.id};
//     for(var key in otherSpotdyData){
//         spotdyData.properties[key] = otherSpotdyData[key];
//     }
//     spotdyData.properties["spotdy_eventname"] = {"value" : "__ecomtics_searchload","type" : "string"};
//     spotdyData.properties["eventType"] = {"value" : "searchBarEvent","type" : "string"};
//     for(var key in spotdyData.properties)
//         if(spotdyData.properties[key].value === "" || spotdyData.properties[key].value === undefined)
//             delete spotdyData.properties[key];
//     var url = urlToSendDataToServer + encodeURIComponent(JSON.stringify(spotdyData))+ "&type=clickstream.events";
//     var xhttp = spotdyGetXmlHttpObject();
    
//     xhttp.onreadystatechange = function () {
//         if (xhttp.readyState == 4 && xhttp.status == 200) {
//             if(searchedKeyword !== null && searchedKeyword !== '')
//             window.location = '/search?search_query='+searchedKeyword+'&start=0';
//         }
//     };
//     xhttp.open("GET", url, true);
//     xhttp.send();
// }
function sendSearchBarEnterEvent(searchedKeyword,e){
    ct = 0;
    isLoadMore = false;
    if(document.getElementById('pageStartVal'))
    document.getElementById('pageStartVal').value = 0;
    if(document.getElementById('queryParamsDatafacet'))
    document.getElementById('queryParamsDatafacet').value ='?start=0'
    var spotdyData = {properties : {}};
    spotdySession = window.sessionStorage.sessionId;
    spotdySession = JSON.parse(spotdySession);
    if(searchedKeyword)
        spotdyData.properties["keyword"] = {"type":"string","value":searchedKeyword.toString()};

    spotdyData.properties["date"] = {"type" : "ISO_DATE","value" : new Date().toISOString() };
    if(generateUUID())
    spotdyData.properties["spotdy_eventid"] = {"value":generateUUID().toString(),"type":"string"};
    spotdyData.properties["currentPageUrl"] = {"type": "string" , "value" :window.location.href.toString()};
    if(spotdySession.id)
    spotdyData.properties["spotdySessionId"] = {"type" : "string","value": spotdySession.id.toString()};
    for(var key in otherSpotdyData){
        spotdyData.properties[key] = otherSpotdyData[key];
    }
    spotdyData.properties["spotdy_eventname"] = {"value" : "__ecomtics_searchload","type" : "string"};
    spotdyData.properties["eventType"] = {"value" : "searchBarEvent","type" : "string"};
    for(var key in spotdyData.properties)
        if(spotdyData.properties[key].value === "" || spotdyData.properties[key].value === undefined)
            delete spotdyData.properties[key];
    var url = urlToSendDataToServer + encodeURIComponent(JSON.stringify(spotdyData))+ "&type=clickstream.events";
    var xhttp = spotdyGetXmlHttpObject();
    
    xhttp.onreadystatechange = function () {
        if (xhttp.readyState == 4 && xhttp.status == 200) {
            if(searchedKeyword !== null && searchedKeyword !== ''){
                if(document.getElementById('cartup-search-wrapper')){
                    var t = document.getElementById('cartup-search-wrapper');
                    if(!t.classList.contains('show'))
                    t.classList.add('show');
                    if(document.getElementsByClassName('cu-suggestion-container').length>0){
                        var t1 = document.getElementsByClassName('cu-suggestion-container')[0];
                        t1.classList.remove('show');
                    }
                }
            }
        }
    };
    xhttp.open("GET", url, true);
    xhttp.send();
}

function sendSearchResultProductClickEvent(searchedKeyword,proSku,proName,proUrl,proPrice,proNo,e){
    var spotdyData = {properties : {}};
    spotdySession = window.sessionStorage.sessionId;
    spotdySession = JSON.parse(spotdySession);
    if(searchedKeyword)
        spotdyData.properties["keyword"] = {"type":"string","value":searchedKeyword.toString()};
    if(proSku)
        spotdyData.properties["sku"] = {"type":"string","value":proSku.toString()};
    if(proName)
        spotdyData.properties["productname"] = {"type":"string","value":proName.toString()};
    if(proUrl)
        spotdyData.properties["producturl"] = {"type":"string","value":proUrl.toString()};
    if(proPrice){
        proPrice = proPrice.replace('ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã…Â¡Ãƒâ€šÃ‚Â¬ ', '').replace('ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã…Â¡Ãƒâ€šÃ‚Â¬', '').replace('$ ', '').replace('$', '').replace('ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â£', '').replace('Ãƒâ€šÃ‚Â£', '').replace('Ã‚Â£', '').replace('Ã¢â€šÂ¬','').replace('AED','').replace('AED ','');
        if(proPrice.includes(',') && proPrice.includes('.')){
            proPrice = proPrice.replace(',', '')
            if(parseFloat(proPrice) >=1000){
                proPrice = parseFloat(proPrice)
            }
        }else{
            proPrice = proPrice.replace(',', '.')
        }
        proPrice = parseFloat(proPrice);
        spotdyData.properties["productprice"] = {"type":"double","value":parseFloat(proPrice)};
    }
    if(proNo)
        spotdyData.properties["productindex"] = {"type":"long","value":proNo};
    spotdyData.properties["date"] = {"type" : "ISO_DATE","value" : new Date().toISOString() };
    if(generateUUID())
    spotdyData.properties["spotdy_eventid"] = {"value":generateUUID().toString(),"type":"string"};
    spotdyData.properties["currentPageUrl"] = {"type": "string" , "value" :window.location.href.toString()};
    if(spotdySession.id)
    spotdyData.properties["spotdySessionId"] = {"type" : "string","value": spotdySession.id.toString()};
    for(var key in otherSpotdyData){
        spotdyData.properties[key] = otherSpotdyData[key];
    }
    spotdyData.properties["spotdy_eventname"] = {"value" : "__ecomtics_searchclick","type" : "string"};
    spotdyData.properties["eventType"] = {"value" : "searchResultProduct","type" : "string"};
    for(var key in spotdyData.properties)
        if(spotdyData.properties[key].value === "" || spotdyData.properties[key].value === undefined)
            delete spotdyData.properties[key];
    var url = urlToSendDataToServer + encodeURIComponent(JSON.stringify(spotdyData))+ "&type=clickstream.events";
    var xhttp = spotdyGetXmlHttpObject();
    
    // xhttp.onreadystatechange = function () {
    //     if (xhttp.readyState == 4 && xhttp.status == 200) {
    //         var a = e.target || e;
    //         var els = [];
    //         while (a) {
    //             els.unshift(a);
    //             a = a.parentNode;
    //             if(a && (a.nodeName == "A" || (e.target || e).nodeName == "A"))
    //                 window.location = proUrl
    //         }
    //     }
    // };
    xhttp.open("GET", url, true);
    xhttp.send();
}

function generateUUID() {
    var d = new Date().getTime();
    if (window.performance
        && typeof window.performance.now === "dataProvider") {
        d += performance.now(); // using high-precision timer
    }
    var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,
        function (c) {
            var r = (d + Math.random() * 16) % 16 | 0;
            d = Math.floor(d / 16);
            return (c == 'x' ? r : (r & 0x3 | 0x8)).toString(16);
        });
    return uuid;
};
function cartupBadgingApiCall(sku, pname, orgId, orgName) {
    var payloadObj = {'sku':[sku],'pname':[pname],'orgId':orgId,'orgName':orgName};
    var badgeApiUrl = urlToGetTheWidgetDataFromTheServer + "badge";
    var xmlHttp = new XMLHttpRequest();
    xmlHttp.onreadystatechange = function() { 
        if (xmlHttp.readyState == 4 && xmlHttp.status == 200){
            let obj = JSON.parse(xmlHttp.responseText.trim());
            getCartupProductBading(obj,sku, pname, orgId, orgName);
        }       
    }
    xmlHttp.open("POST", badgeApiUrl, true); 
    xmlHttp.setRequestHeader("Content-Type", "application/json");
    xmlHttp.send(JSON.stringify(payloadObj));
}
function getCartupProductBading(obj,sku, pname, orgId, orgName) {
    for(var k in obj){
        var value = obj[k];
        var transCount = 0;
        var viewCount = 0;
        var productBadgeArr = [];
        if(Array.isArray(value)) {
            for(var index = 0; index < value.length; index++){
                //if(value[index].enabled == true)
                if(value[index].badgePlacement)
                // if(JSON.parse(value[index].badgePlacement).placement === 'product'){
                // insertCartupProductBading(value[index]);
                    if(JSON.parse(value[index].badgePlacement).placement.toLowerCase() === 'product'){
                        if(JSON.parse(value[index].badgeType).name === 'Trending transactions'){
                            productBadgeArr.push(value[index])
                            if(value[index].count)
                            transCount = value[index].count;
                            // insertCartupProductBading(value[index]);
                            // break;
                        }
                        else if(JSON.parse(value[index].badgeType).name === 'Trending views'){
                            productBadgeArr.push(value[index])
                            if(value[index].count)
                            viewCount = value[index].count;
                            // insertCartupProductBading(value[index]);
                            // break;
                        //}else if(JSON.parse(value[index].badgeType).badgeSelectionType === 'Similar search' && (window.location.origin.includes('https://store.itnltestlive.intertoys.business') || window.location.origin.includes('https://usrigging.com') || window.location.origin.includes('https://rigging-demo.mybigcommerce.com') || window.location.origin.includes('https://rigging-demo2.mybigcommerce.com'))){
                        }else if(JSON.parse(value[index].badgeType).badgeSelectionType === 'Similar search' && (window.location.origin.includes('https://usrigging.com') || window.location.origin.includes('https://rigging-demo.mybigcommerce.com') || window.location.origin.includes('https://rigging-demo2.mybigcommerce.com'))){
                            productBadgeArr.push(value[index])
                            if(value[index].count)
                            viewCount = value[index].count;
                            // insertCartupProductBading(value[index]);
                            // break;
                        }
                    }
                //}
            }
            if(productBadgeArr.length){
                for(var index1 = 0; index1 < productBadgeArr.length; index1++){
                    if(transCount === 0 && viewCount > 0 && JSON.parse(productBadgeArr[index1].badgeType).name === 'Trending views'){
                        insertCartupProductBading(productBadgeArr[index1],sku, pname, orgId, orgName);
                        break;
                    }
                    if(transCount > 0 && JSON.parse(productBadgeArr[index1].badgeType).name === 'Trending transactions'){
                        insertCartupProductBading(productBadgeArr[index1],sku, pname, orgId, orgName);
                        break;
                    }
                    //if(JSON.parse(productBadgeArr[index1].badgeType).badgeSelectionType === 'Similar search' && (window.location.origin.includes('https://store.itnltestlive.intertoys.business') || window.location.origin.includes('https://usrigging.com') || window.location.origin.includes('https://rigging-demo.mybigcommerce.com') || window.location.origin.includes('https://rigging-demo2.mybigcommerce.com'))){
                    if(JSON.parse(productBadgeArr[index1].badgeType).badgeSelectionType === 'Similar search' && (window.location.origin.includes('https://usrigging.com') || window.location.origin.includes('https://rigging-demo.mybigcommerce.com') || window.location.origin.includes('https://rigging-demo2.mybigcommerce.com'))){
                        insertCartupProductBading(productBadgeArr[index1],sku, pname, orgId, orgName);
                        break;
                    }
                }
            }
        }
    }
}

function insertCartupProductBading(obj,sku, pname, orgId, orgName){
    var assetType = JSON.parse(obj.assetType);
    var badgePlacement = JSON.parse(obj.badgePlacement);
    var cssSelector = badgePlacement.cssSelector;
    var badgeType = JSON.parse(obj.badgeType);
    if(!badgeType.badgeSelectionType)
    badgeType.badgeSelectionType = 'Attribute type';
    var badgeSelectionType = badgeType.badgeSelectionType;
    var element = document.querySelector(cssSelector);
    if(!element) return;
    var count = 0;
    if(obj.count)
    count = obj.count;

    var getId = (obj.id).replace(/\D/g,'');
    var badgingElement = assetType.assetType == "Text" ? getTextBadging(assetType,count,badgeSelectionType,sku, pname, orgId, orgName, getId) : getImageBadging(assetType,badgeSelectionType,sku, pname, orgId, orgName, getId);
    insertCartupElementBasedOnPosition(element, badgingElement, badgePlacement.position,assetType);
}

function insertCartupElementBasedOnPosition(element, badgingElement, position, obj) {
    if(position == "Top left" || position == "Top right" || position == "Bottom left" || position == "Bottom" || position == "Bottom right" || position == "Top center" || position == "Left center" || position == "Right center" || position == "Bottom center"){
        getProductOverCartupBadgeElement(element, badgingElement, position,obj)
    }else{
        if(position == "Prev element") {
            element.parentNode.insertBefore(badgingElement, element);
        } else if(position == "First element") {
            element.prepend(badgingElement );
        } else if(position == "Next element") {
            element.parentNode.insertBefore(badgingElement, element.nextSibling);
        } else {
            element.appendChild(badgingElement);
        }
    }
}

function getProductOverCartupBadgeElement(elem, badgingElement, position,obj) {
    var element = document.createElement("div");
    element.style.position = "absolute";
    element.style.zIndex = "999";
    if(position == "Top left") {
        element.style.top = "0px";
        element.style.left = "0px";
    } else if(position == "Top right") {
        element.style.top = "0px";
        element.style.right = "0px";
    } else if(position == "Bottom") {
        element.style.bottom = "0px";
    } else if(position == "Bottom left") {
        element.style.bottom = "0px";
        element.style.left = "0px";
    } else if(position == "Bottom right") {
        element.style.bottom = "0px";
        element.style.right = "0px";
    } else if(position == "Top center") {
        element.style.top = "0px";
        element.style.left = "0px";
        element.style.right = "0px";
        element.style.margin = "0 auto";
        element.style.height = "auto";
    } else if(position == "Left center") {
        element.style.top = "48%";
        element.style.left = "0px";
        element.style.right = "auto";
        element.style.height = "auto";
    } else if(position == "Right center") {
        element.style.top = "48%";
        element.style.right = "0px";
        element.style.left = "auto";
        element.style.height = "auto";
    } else if(position == "Bottom center") {
        element.style.top = "auto";
        element.style.bottom = "0px";
        element.style.left = "0px";
        element.style.right = "0px";
        element.style.margin = "0 auto";
        element.style.height = "auto";
    }
    
    var width = parseInt(obj.badgeSize.split(" ")[0]);
    var height = parseInt(obj.badgeSize.split(" ")[1]);
    element.style.maxWidth = width + "px";
    element.style.width = "100%";
    element.style.height = height + "px";
    element.style.minHeight = height + "px";
    element.appendChild(badgingElement);
    // let elementObj = elem.querySelector(".cartupBadgeElement");
    // if(!elementObj) return element;
    elem.style.position = "relative";
    element.style.backgroundColor = obj.backgroundColor;
    element.style.padding = "10px";
    if(obj.badgeShape == "circular rectangle") {
        element.style.borderRadius = "5px";
    }
    elem.appendChild(element);
   // return elem;
}

function getTextBadging(obj,count,badgeSelectionType,sku, pname, orgId, orgName,getId) {
    if(obj.title)
        var title = obj.title;
    else
        var title = 'Shopping matches';

    var element = document.createElement("span");
    element.className = "textBadgeSpan";
    if(count>0)
    if((obj.title).includes('{{COUNT}}')){
        obj.title = (obj.title).replace('{{COUNT}}',count)
    }
    element.innerHTML = obj.title;
    element.style.backgroundColor = obj.backgroundColor;
    element.style.fontSize = obj.fontSize + "px";
    element.style.fontFamily = obj.fontFamily;
    element.style.fontStyle = obj.fontStyle;
    element.style.color = obj.fontColor;
    //var width = parseInt(obj.badgeSize.split(" ")[0]);
    //var height = parseInt(obj.badgeSize.split(" ")[1]);
    // element.style.width = width + "px";
    // element.style.height = height + "px";
    //element.style.maxWidth = width + "px";
    element.style.width = "100%";
    //element.style.minHeight = height + "px";
    //element.style.width = "50px";
    //element.style.height = "50px";
    element.style.display = "inline-block";
    element.style.textAlign = "center";
    element.style.verticalAlign = "middle";
    element.style.fontWeight = "600";
    element.style.lineHeight = "16px";
    //element.style.textOverflow = "ellipsis";
    //element.style.whiteSpace = "nowrap";
    //element.style.overflow = "hidden";
    if(obj.badgeShape == "circular rectangle") {
        element.style.borderRadius = "5px";
    }
    var createSt = document.createElement('style');
    createSt.append('@media (max-width: 576px){.proBadgeWrapper{width:auto !important;text-align:left !important;}.textBadgeSpan{font-size:10.5px !important;}}@media (max-width: 460px){.textBadgeSpan{font-size:7.5px !important;}}@media (max-width: 210px){.textBadgeSpan{font-size:7px !important;}}');
    document.body.append(createSt);
    if(badgeSelectionType === 'Similar search'){
        element.setAttribute('class','similarSearchEle');
        element.setAttribute('id','similarSearchEle_'+getId);
        element.style.cursor = "pointer";
        //var payloadObj = {'sku':sku,'pname':pname,'orgId'=orgId,'orgName':orgName};
        
        var similarSearchApiUrl = CARTUP_SIMILAR_SEARCH+"?request=%7B%22orgId%22%3A%22"+orgId+"%22%2C%22orgName%22%3A%22"+orgName+"%22%2C%22pname%22%3A%22"+pname+"%22%2C%22sku%22%3A%22"+sku+"%22%2C%22type%22%3A%22image%22%7D";
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                var data = {};
                try {
                    data = JSON.parse(this.responseText);
                    let obj = data.docs || data.products;
                    
                    if(obj){
                        if(obj.length>0){
                            obj = refactorCartupPriceData(obj);
                            getSimilarSearchConfiguration(obj,getId,title)
                        }
                    }
                
            } catch (err) {}
            }       
        }
        xhttp.open("GET", similarSearchApiUrl, true); 
        //xhttp.setRequestHeader("Content-Type", "application/json");
        xhttp.send(null);
        
        element.addEventListener('click',function(){
            if(document.getElementById('similarSearch')){
                document.getElementById('similarSearch').classList.toggle('show');
            }
        })
        
        
    }
    return element;
}

function toggleSimilarSearch(getId){
    if(document.getElementById('similarSearch_'+getId)){
        document.getElementById('similarSearch_'+getId).classList.toggle('show');

        if(document.getElementsByClassName('similar-left-content').length>0 && document.getElementsByClassName('similar-right-content').length>0)
        document.getElementsByClassName('similar-left-content')[0].style.height = document.getElementsByClassName('similar-right-content')[0].clientHeight+'px';
        //document.body.classList.toggle('cartupOverlay');

        if(document.getElementById('similarSearch_'+getId).classList.contains('show')){
            document.getElementById('cartupOverlay').style.display="block";
            window.scroll({
                top: '10%', 
                left: 0, 
                behavior: 'smooth' 
            });
        }
        // var getTop = document.getElementById('similarSearchEle_'+getId).getBoundingClientRect().top
        // document.getElementById('similarSearch_'+getId).style.top = parseFloat(getTop)+"px";
    }
}

function getSimilarSearchConfiguration(obj,getId,title){
    var overlayEle = document.createElement('div');
    overlayEle.id = "cartupOverlay"
    document.body.append(overlayEle);
    var similarSearchEle = document.createElement('div');
    similarSearchEle.setAttribute('class','similarSearch');
    similarSearchEle.setAttribute('id','similarSearch_'+getId);
    if(window.location.origin.includes('https://usrigging.com') || window.location.origin.includes('https://rigging-demo.mybigcommerce.com') || window.location.origin.includes('https://rigging-demo2.mybigcommerce.com'))
    similarSearchEle.classList.add('container')
    //similarSearchEle.style.position = 'absolute';
    //similarSearchEle.style.display = 'none';

    var str = "";
    str = '<style>#cartupOverlay{display:none;background: rgba(0,0,0,.3);height: 100%;left: 0;position: absolute;top: 0;width: 100%;z-index: 898;}.similarSearch{position: absolute;z-index: 99999999;width: 100%;max-width: 1164px;left: 0;right: 0;margin: 0 auto;background:#efefef;padding: 15px 15px;border: 1px solid #ddd;top:5%;opacity: 0;visibility:hidden;transition: all 0.4s ease-in-out;}@media (max-width: 1200px){.similarSearch{max-width:1000px;width:auto}}.similarSearch.container{left:0;max-width:1200px}.similarSearch.show{opacity: 1;visibility:visible;transition: all 0.4s ease-in-out;}.similarSearch .variantDiv{display:block;z-index:999;width:100%;max-width:184px}.similarSearch .variantdropdown{height:34px;width:100%;padding:5px;margin:5px 0;font-size:1rem;line-height:1.5;color:#495057;font-size:13px;background-color:#fff;background-clip:padding-box;border:1px solid #ced4da;transition:border-color .15s ease-in-out,box-shadow .15s ease-in-out}.similarSearch .product-image-photo{max-height:200px !important}.similarSearch .variantdropdown:focus{outline:none;box-shadow:none}.similarSearch .soldOutVariantPro{border-color:#999!important;background-color:#e6e6e6!important;color:#999!important;cursor:not-allowed}.similarSearch .qty-cartBtn-wrapper{width:100%;padding:5px 0 15px;max-width:198px}.similarSearch .products.wrapper{width:100%;position:relative;min-height:650px;margin:auto;overflow-x:hidden;overflow-y:hidden}.similarSearch .cartup-widget-wrapper{width:100%;min-height:300px !important;height:565px}.similarSearch .similarName{font-weight:500;max-width:160rem!important;display:inline-block;margin:0 auto 20px!important;text-align:left;font-size:24px;color:rgb(28,27,27)}.similarSearch ol.products{display:inline-block;position:relative;padding:0;margin-top:0;transition:0.3s left ease-in-out}.similarSearch ol li.product-item{vertical-align:top;display:inline-block;align-items:center;border-radius:.5rem;transition:all .2s ease;margin:0;padding:0;width: 32%;}.similarSearch li.product-item a.product-item-link{display:block;text-decoration:none;color:#1C1B1B;font-weight:400;font-size:16px;line-height:normal}.similarSearch .product-item-info:hover{box-shadow:0 3px 16px 0 rgb(0 0 0 / 11%)}.similarSearch .product-item-info{margin:2px;padding:5px 15px;/*border:1px solid #dddddd4f;border-radius:5px*/}.similarSearch .product-image-wrapper{display:inline-block;min-height:15px}.similarSearch .product-item-name{padding:0 0 0 0;min-height:42px;display:block;margin-top:5px;overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}.similarSearch .product-item-details{margin:0;padding:0 !important}.similarSearch .product-item-name a{width:100%!important}.similarSearch .product-image-wrapper img{max-height:none!important;min-height:none!important;width:350px;height:490px}.similarSearch .secondary-addto-links button.action{background:#1C1B1B;color:#FFF;box-shadow:0;border-radius:0;cursor:pointer;padding:5px 10px;margin-bottom:5px;display:block;text-align:center;text-decoration:none;font-size:13px;font-weight:500;margin-top:7px;transition:all 0.2s ease-in-out}.similarSearch .ctrl-btn.pro-prev{left:15px}.similarSearch .ctrl-btn.pro-next{right:25px}.similarSearch .ctrl-btn{box-shadow:0 0 0 1px rgb(0 0 0 / 4%),0 1px 8px 0 rgb(0 0 0 / 20%);cursor:pointer;height:36px;width:36px;border-radius:999rem;border:1px solid #dfe1e5;background-color:#FFF;color:#70757a;opacity:.9;position:absolute;top:50%;margin-top:-27.5px;z-index:999}.similarSearch ol li.product-item .price{display:inline-block}.similarSearch li.product-item .discountedPrice{display:inline-block;font-size:14px;text-decoration:line-through}@media (max-width: 844px){.similarSearch ol li.product-item{width:50%}}@media (max-width: 767px){.similarSearch ol.products{width:100% !important;margin-top:15px;}.similarSearch .similar-left-content{width:100% !important;max-height:315px;border-bottom:1px solid rgb(220, 220, 220) !important;border-right:0 !important}.similarSearch ol li.product-item{width:48%}.similarSearch li.product-item a.product-item-link{font-size:14px}}@media (max-width: 480px){.similarSearch{width:auto;left:0;padding:7.5px}.similarSearch .product-image-photo{max-height:150px !important}}</style>';
    
    //str += '<script>function addToCartAction(t){$(".header__cart__count").show(),$(".cart-count-bubble").show();var e=parseInt($(".header__cart__count").html()),a=parseInt($(".cart-count-bubble span:first-child").html());if((offSetElem=t.closest("[isarray]"))||console.log("not found"),offSetElem&&offSetElem.getElementsByClassName("proId").length>0)var s=offSetElem.getElementsByClassName("proId")[0].value;else s=0;if(offSetElem&&offSetElem.getElementsByClassName("quantity__input").length>0)var n=offSetElem.getElementsByClassName("quantity__input")[0].value;else n=0;if(offSetElem.getElementsByClassName("variantdropdown").length>0){var l=offSetElem.getElementsByClassName("variantdropdown")[0];0==s?l.style.cssText="border:1px solid red":l.style.cssText="border:1px solid #ced4da"}s&&""!=s&&null!=s&&0!=s&&n&&""!=n&&null!=n&&0!=n&&(data={id:s,quantity:n},$.ajax({type:"POST",url:"/cart/add.js",data:data,dataType:"json",success:function(){$.ajax({type:"GET",url:"/cart.js",cache:!1,dataType:"json",success:function(t){0==t.item_count?($(".header__cart__count").html(parseInt(e)+2),$(".cart-count-bubble span:first-child").html(parseInt(a)+2)):($(".header__cart__count").html(t.item_count),$(".cart-count-bubble span:first-child").html(t.item_count)),t.item_count=t.item_count}})}}))}</script>';
    str += '<div style="position:relative;margin:0 auto;padding:1px 12px 20px 12px;background: #fff;">';
    str += '<div class="similarName" style="float: left;">'+title+'</div>';
    str += '<div class="closeModal" style="float: right;font-size: 24px;font-weight: 600;cursor:pointer">x</div>';
    str += '<div class="products wrapper products-related cartup-widget-wrapper" id="test-widget-wrapper">';
        str += '<div class="similar-left-content" style="float:left;width:27%;border-right:1px solid rgb(220, 220, 220);">';
            str += '<li class="item product-item" style="list-style:none;">';
            str += '<div class="product-item-info" style="position:relative;padding: 5px 10px;"><a href="'+obj[0].currentPageUrl+'" class="photo product-item-photo cartupBadgeElement"><input type="hidden" class="mainProductId" value="'+obj[0].sku+'"><span class="product-image-container product-image-container-452"><span class="media media--transparent media--square media--hover-effect"><img class="product-image-photo" src="'+obj[0].smallImage+'" loading="lazy" alt="'+obj[0].name+'" style="max-height:none"></span></span></a>';
            str += '<div class="product details product-item-details"><strong class="product name product-item-name" style="min-height:25px"><a class="product-item-link" href="'+obj[0].currentPageUrl+'"><input type="hidden" class="mainProductId" value="'+obj[0].sku+'">'+obj[0].name+'</a></strong>';
            str += '<div class="price-box price-final_price" data-role="priceBox" data-product-id="452" data-price-box="product-id-452"><span class="normal-price"><span class="price-container price-final_price tax weee"><span id="product-price-452" data-price-type="finalPrice" class="price-wrapper">';
            if(obj[0].discountedPrice)
                if(parseFloat(obj[0].discountedPrice) > 0)
                    str += '<span class="discountedPrice money money1">'+obj[0].discountedPrice+'</span>';
            str += '<span class="price money money2">'+obj[0].nodiscountPrice+obj[0].price+'</span></span></span></span></div>';
            str += '</div>';
            str += '</div>';
            str += '</li>';
        str += '</div>';

        str += '<ol class="similar-right-content products list items product-items grid" style="float:right;width:71%;max-height: 565px;overflow-y: auto;">';
                for(var i=0;i<obj.length;i++){
                    if(i != 0){
                        str += '<li class="item product-item" style="list-style:none;">';
                        str += '<div class="product-item-info" style="position:relative;"><a href="'+obj[i].currentPageUrl+'" class="photo product-item-photo cartupBadgeElement"><input type="hidden" class="mainProductId" value="'+obj[i].sku+'"><span class="product-image-container product-image-container-452"><span class="media media--transparent media--square media--hover-effect"><img class="product-image-photo" src="'+obj[i].smallImage+'" loading="lazy" alt="'+obj[i].name+'" style="max-height:none"></span></span></a>';
                        str += '<div class="product details product-item-details"><strong class="product name product-item-name"><a class="product-item-link" href="'+obj[i].currentPageUrl+'"><input type="hidden" class="mainProductId" value="'+obj[i].sku+'"> '+obj[i].name+'</a></strong>';
                        str += '<div class="price-box price-final_price" data-role="priceBox" data-product-id="452" data-price-box="product-id-452"><span class="normal-price"><span class="price-container price-final_price tax weee"><span id="product-price-452" data-price-amount="29" data-price-type="finalPrice" class="price-wrapper">';
                        if(obj[i].discountedPrice)
                            if(parseFloat(obj[i].discountedPrice) > 0)
                            str += '<span class="discountedPrice money money1">'+obj[i].discountedPrice+'</span>';
                        str += '<span class="price money money2">'+obj[0].nodiscountPrice+obj[i].price+'</span><span class="price money money3"></span></span></span></span></div>';
                        str += '</div>';
                        str += '</div>';
                        str += '</li>';
                    }
                }
        str += '</ol>';
    str += '</div>';
    str += '</div>';
    similarSearchEle.innerHTML = str;
    document.body.append(similarSearchEle);
    if(document.getElementsByClassName('closeModal').length>0){
        document.getElementsByClassName('closeModal')[0].addEventListener('click',function(){
            if(document.getElementById('similarSearch_'+getId)){
                document.getElementById('similarSearch_'+getId).classList.remove('show');
                document.getElementById('cartupOverlay').style.display="none";
            }
        })
    }
}

function getImageBadging(obj,badgeSelectionType,sku, pname, orgId, orgName,getId) {
    if(obj.title)
        var title = obj.title;
    else
        var title = 'Shopping matches';

    var element = document.createElement("img");
    element.setAttribute("src", obj.cdn);
    var width = parseInt(obj.badgeSize.split(" ")[0]);
    var height = parseInt(obj.badgeSize.split(" ")[1]) || parseInt(obj.badgeSize);
    element.style.maxWidth = width + "px";
    element.style.width = width + "px";
    //element.style.width = "50px";
    element.style.height = height + "px";
    //element.style.maxHeight  = "29px";
    //element.style.height = "50px";
    if(badgeSelectionType === 'Similar search'){
        element.setAttribute('class','similarSearchEle');
        element.setAttribute('id','similarSearchEle_'+getId);
        element.style.cursor = "pointer";
        //var payloadObj = {'sku':sku,'pname':pname,'orgId'=orgId,'orgName':orgName};
        
        var similarSearchApiUrl = CARTUP_SIMILAR_SEARCH+"?request=%7B%22orgId%22%3A%22"+orgId+"%22%2C%22orgName%22%3A%22"+orgName+"%22%2C%22pname%22%3A%22"+pname+"%22%2C%22sku%22%3A%22"+sku+"%22%2C%22type%22%3A%22image%22%7D";
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                var data = {};
                try {
                    data = JSON.parse(this.responseText);
                    let obj = data.docs || data.products;
                    
                    if(obj){
                        if(obj.length>0){
                            obj = refactorCartupPriceData(obj);
                            //if(!document.getElementById('similarSearch'))
                            getSimilarSearchConfiguration(obj,getId,title);
                        }
                    }
                
            } catch (err) {}
            }       
        }
        xhttp.open("GET", similarSearchApiUrl, true); 
        //xhttp.setRequestHeader("Content-Type", "application/json");
        xhttp.send(null);
        
        // element.addEventListener('click',function(){
        //     if(document.getElementById('similarSearch')){
        //         document.getElementById('similarSearch').classList.toggle('show');
        //     }
        // })
        
    }
    return element;
}

function getDotsConfiguration(orgId){
    var dotsObj = [];
    let raw = JSON.stringify({"collectionName":"config_collection","fields":"{\"orgID_s\":\""+orgId+"\",\"doc_type_s\":\"dots_conf\"}"});
    const getRequestOptions = {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: raw,
        redirect: 'follow'
    };
    var element
    fetch(CARTUP_DOTS_URL,getRequestOptions
      ).then(async response => {
        var data = await response.json();
        if(data.documents)
        dotsObj = data.documents;

    var createSt = document.createElement('style');
    createSt.append('.mobileResp{display:none;cursor:pointer}.deskResp{display:block;cursor:pointer}.dotTypeIcon .closeDots svg.closePopup{opacity:0;transform:rotate(45deg);-webkit-transition: all 0.4s ease-in-out; transition: all 0.4s ease-in-out;}.dotTypeIcon:hover .closeDots svg.closePopup{opacity:1;-webkit-transition: all 0.4s ease-in-out; transition: all 0.4s ease-in-out;}.dotTypeIcon .closeDots svg.closePopupdivRot{transform:rotate(0);opacity:1;-webkit-transition: all 0.4s ease-in-out; transition: all 0.4s ease-in-out;}.popOverDiv {padding:15px;width: 100%; position: absolute;  background: rgb(255, 255, 255); min-height: 10px; top: 13%; left: 22px; border: 1px solid rgb(221, 221, 221);opacity:0;-webkit-transition: opacity 0.4s ease-in-out; transition: opacity 0.4s ease-in-out;}.popOverDiv.rot {padding:15px;opacity:1 !important;}.popOverDiv .closeDots{position: absolute;top: 0px;right: 0;align-items: center;justify-content: center;cursor: pointer;}.closeDots:hover{font-weight:700;cursor:pointer}a.flyout-content{text-decoration:none;padding:0 !important;display:block;width: 100%;min-height: 12px;}.flyout-cta{background-color: #333;cursor:pointer;border: 0;border-radius: 4px;padding: 7px 10px;font-size: 12px;color: #fff;margin-top: 6px;display: block;width: auto;}.flyout-name{color: #000;font-size:13px;width:100%;line-height:19px;}.flyout-img{margin-right:10px;float:left;max-width: 25% !important;}.flyout-img img{height:100% !important;max-width:85px;width:100% !important}.flyout-copy{margin-top:5px;float:right;width:68% !important;}.popOverDiv.rot{z-index:9999}.left_espot{z-index:auto !important}@media (max-width: 750px){.deskResp{display:none}.mobileResp{display:block}.popOverDiv{max-width: 250px !important;top:25% !important;left: 0 !important;right: 0 !important;margin: 0 auto; width: auto !important;}.flyout-copy{width:68% !important}.popOverDiv{min-height:82px !important;}}')
    document.body.append(createSt);
    if(dotsObj.length>0){
        for(var ob=0;ob<dotsObj.length;ob++){

            if(dotsObj[ob].doc_type_s === 'dots_conf' && dotsObj[ob].is_enabled_b === true){
                if(dotsObj[ob].config_s)
                    dotsObj[ob].config_s = JSON.parse(dotsObj[ob].config_s);
                if(dotsObj[ob].config_s){
                    if(dotsObj[ob].config_s.configuration){
                        var imgWidth = dotsObj[ob].config_s.configuration[0].width;
                        var imgHeight = dotsObj[ob].config_s.configuration[0].height;
                    }
                    var mobileView = dotsObj[ob].config_s.view[0].mobile;
                    if(dotsObj[ob].config_s.enableFlash){
                        if(dotsObj[ob].config_s.enableFlash === 'false' || dotsObj[ob].config_s.enableFlash === false)
                        dotsObj[ob].config_s.enableFlash = false;
                        else
                        dotsObj[ob].config_s.enableFlash = true;
                    }else{
                        dotsObj[ob].config_s.enableFlash = false
                    }
                    var enableFlash = dotsObj[ob].config_s.enableFlash;
                    
                    if(dotsObj[ob].config_s.dotsList){
                        for(var d=0;d<dotsObj[ob].config_s.dotsList.length;d++){
                            
                            var type = dotsObj[ob].config_s.dotsList[d].type;
                            if(type === 'Custom image'){
                                originalWidth = dotsObj[ob].config_s.dotsList[d].imgWidth;
                                originalHeight = dotsObj[ob].config_s.dotsList[d].imgHeight;
                                var name = dotsObj[ob].config_s.dotsList[d].name;
                                var imgSelector = dotsObj[ob].config_s.dotsList[d].cdn;
                                var blockWidth = dotsObj[ob].config_s.dotsList[d].width;
                                var blockHeight = dotsObj[ob].config_s.dotsList[d].height;
                                var customDots = dotsObj[ob].config_s.dotsList[d].customDots;
                                var dotsPlace = dotsObj[ob].config_s.dotsList[d].placement;
                                var dotsPosition = dotsObj[ob].config_s.dotsList[d].position;
                                element = document.querySelector(dotsPlace);
                                //insertDotsBasedOnPosition(element, imgEle, dotsPosition);
                                var sourceImg = imgSelector;
                                if(imgSelector){
                                sourceImg = imgSelector.replace(/(^\w+:|^)\/\//, '');
                                }
                                if(element)
                                    var allImages = element.getElementsByTagName("img");
                                else
                                    var allImages = document.getElementsByTagName("img");
                                var target = null;
                                for(var i = 0, max = allImages.length; i < max; i++)
                                    if (allImages[i].src.includes(sourceImg) || allImages[i].srcset.includes(sourceImg)){
                                    target = allImages[i];
                                    break;
                                    }
                                
                                if(target && element){
                                    resizeImage = target;
                                    // originalWidth = resizeImage.clientWidth;
                                    responsiveWidth = resizeImage.clientWidth;
                                    responsiveHeight = resizeImage.clientHeight;
                                    target = target.parentElement;
                                    //console.log( target)

                                    if(customDots.length>0){
                                        //if(document.getElementsByClassName('viewDot'+name+d).length == 0)
                                        for(var cD=0;cD<customDots.length;cD++){
                                            var dotEle = document.createElement('div');
                                            var xCoordinate = customDots[cD].x;
                                            var yCoordinate = customDots[cD].y;
                                            var dotColor = customDots[cD].color;
                                            var dotWidth = imgWidth;
                                            var dotHeight = imgHeight;
                                            var dotType = customDots[cD].type;
                                            var dotTypeVal = customDots[cD].value;
                                            var dotTypeProVal = customDots[cD].proHtml;
                                            //var getId = customDots[cD].id
                                            var getId = cD;
                                            var tType = 'Custom'
                                            dotEle.setAttribute('alt',cD+tType+d);
                                            dotEle.setAttribute('class','dotTypeIcon');
                                            dotEle.setAttribute('data-order',cD+d);
                                            dotEle.setAttribute('id','dotType'+cD+tType+d);
                                            dotEle.setAttribute('data-toggle','tooltip');
                                            //dotEle.setAttribute('title',name);
                                            dotEle.style.position = 'absolute';
                                            dotEle.style.cursor = 'pointer';
                                            dotEle.style.left = parseFloat(xCoordinate-4)+'px';
                                            //dotEle.style.left = parseFloat(responsiveWidth-22.80)-(xCoordinate-4)+'px';
                                            //if(d==0)
                                            dotEle.style.top = parseFloat(yCoordinate-4)+'px';
                                            //dotEle.style.top = parseFloat(responsiveHeight-22.80)-(yCoordinate-4)+'px';
                                            dotEle.style.backgroundColor = dotColor;
                                            dotEle.style.height = dotHeight+'px';
                                            dotEle.style.width = dotWidth+'px';
                                            dotEle.style.borderRadius = '50%';
                                            dotEle.style.display = 'block';
                                            dotEle.style.zIndex  = 999;

                                            //media screen responsive 
                                            var newEle = null;
                                            var leftVal = parseFloat(originalWidth)/parseFloat(dotEle.style.left);
                                            if(leftVal > 0){
                                                var leftVal1 = parseFloat(responsiveWidth)/leftVal;
                                                dotEle.style.left = leftVal1+'px';
                                            }
                                            var topVal = parseFloat(originalHeight)/parseFloat(dotEle.style.top);
                                            if(topVal > 0){
                                                var topVal1 = parseFloat(responsiveHeight)/topVal;
                                                dotEle.style.top = topVal1+'px';
                                            } 
                                            //end of media screen responsive 
                                            var strokeColor = adjustTextColor(dotColor);
                                            

                                            
                                            dotEle.innerHTML = '<div class="closeDots deskResp" alt="'+getId+tType+d+'" style="width:'+dotWidth+'px;height:'+dotHeight+'px"><svg class="closePopup" alt="'+getId+tType+d+'" width="'+dotWidth+'" height="'+dotHeight+'" viewBox="0 0 31 31" fill="none" xmlns="http://www.w3.org/2000/svg"><path class="closePopup" alt="'+getId+tType+d+'" d="M10.8164 10.8242L19.7238 19.7317" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="stroke:'+strokeColor+';"></path><path class="closePopup" alt="'+getId+tType+d+'" d="M10.8164 19.7324L19.7238 10.825" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="stroke:'+strokeColor+';"></path></svg></div>'
                                            if(target)
                                            insertDotsBasedOnPosition(target, dotEle, dotsPosition); 
                                            if(!document.getElementById('dotType_'+getId+tType+d)){
                                            if(dotType === 'Info' && target && element){
                                                if(dotTypeVal !== null && dotTypeVal !== '')
                                                {
                                                    html = dotTypeVal.trim(); 
                                                    newEle = html
                                                }
                                                
                                                var popOutEle1 = document.createElement('div');
                                                    popOutEle1.setAttribute('class','popOverDiv popOverDivInfo');
                                                    element.appendChild(popOutEle1);
                                                    //var tType = 'Custom'
                                                    popOutEle1.setAttribute('id','dotType_'+getId+tType+d);
                                                    if(newEle)
                                                    popOutEle1.innerHTML = '<div class="closeDots mobileResp" alt="'+getId+tType+d+'"><svg class="closePopup" alt="'+getId+tType+d+'" width="'+dotWidth+'" height="'+dotHeight+'" viewBox="0 0 31 31" fill="none" xmlns="http://www.w3.org/2000/svg"><path class="closePopup" alt="'+getId+tType+d+'" d="M10.8164 10.8242L19.7238 19.7317" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="stroke:#000;"></path><path class="closePopup" alt="'+getId+tType+d+'" d="M10.8164 19.7324L19.7238 10.825" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="stroke:#000;"></path></svg></div>'+newEle;
                                                    if(document.getElementById('dotType'+getId+tType+d))
                                                    var topStyle = parseFloat(document.getElementById('dotType'+getId+tType+d).style.top)+parseFloat(document.getElementById('dotType'+getId+tType+d).style.height);
                                                    else
                                                    var topStyle = parseFloat(yCoordinate-4)+parseFloat(dotHeight);
                                                    
                                                    popOutEle1.style.top = parseFloat(topStyle-4)+'px';
                                                    //popOutEle1.style.marginTop = "4px";
                                                    if(document.getElementById('dotType'+getId+tType+d))
                                                    var leftStyle = parseFloat(document.getElementById('dotType'+getId+tType+d).style.left)+parseFloat(document.getElementById('dotType'+getId+tType+d).style.width);
                                                    else
                                                    var leftStyle = parseFloat(xCoordinate-4)+parseFloat(dotWidth);
                                                    popOutEle1.style.left = parseFloat(leftStyle)+'px';
                                                    //popOutEle1.style.marginLeft = "4px";
                                                    popOutEle1.style.maxWidth = blockWidth+'px';
                                                    popOutEle1.style.maxHeight = blockHeight+'px';
                                                // popOutEle1.style.zIndex = 99;
                                                    if(enableFlash === false){
                                                        popOutEle1.style.transform = 'none';
                                                    }
                                                    //manage left position according to media screen
                                                    if(window.screen.width > 750){
                                                        var totalWidth = parseFloat(popOutEle1.clientWidth+parseFloat(popOutEle1.style.left));
                                                        if(totalWidth>window.screen.width){
                                                        var calcLeft = totalWidth - window.screen.width;
                                                            calcLeft = parseFloat(popOutEle1.style.left) - parseFloat(calcLeft);
                                                            popOutEle1.style.left = parseFloat(calcLeft)+parseFloat(5)+'px';
                                                            popOutEle1.style.marginTop = 5+'px';
                                                            popOutEle1.style.top = parseFloat(popOutEle1.style.top)+parseFloat(10)+'px';
                                                        }
                                                        
                                                        var totalHeight = parseFloat(popOutEle1.clientHeight+parseFloat(popOutEle1.style.top));
                                                        if(target)
                                                        if(totalHeight>target.clientHeight){
                                                            var calcTop = totalHeight - target.clientHeight;
                                                            calcTop = parseFloat(popOutEle1.style.top) - parseFloat(calcTop);
                                                            //popOutEle1.style.marginTop = "8px";
                                                            if(calcTop-dotHeight > 0)
                                                            popOutEle1.style.top = parseFloat(calcTop-dotHeight)+'px';
                                                            // else
                                                            // popOutEle1.style.top = 0;
                                                        }
                                                    }
                                            }
                                            if(dotType === 'Product' && target && element){
                                                if(dotTypeProVal !== null && dotTypeProVal !== '')
                                                {
                                                    html = dotTypeProVal.trim(); 
                                                    newEle = html
                                                }
                                                var popOutEle1 = document.createElement('div');
                                                    popOutEle1.setAttribute('class','popOverDiv popOverDivProduct');
                                                    element.appendChild(popOutEle1);
                                                    //var tType = 'Custom'
                                                    popOutEle1.setAttribute('id','dotType_'+getId+tType+d);
                                                    if(newEle)
                                                    popOutEle1.innerHTML = '<div class="closeDots mobileResp" alt="'+getId+tType+d+'"><svg class="closePopup" alt="'+getId+tType+d+'" width="27" height="27" viewBox="0 0 31 31" fill="none" xmlns="http://www.w3.org/2000/svg"><path class="closePopup" alt="'+getId+tType+d+'" d="M10.8164 10.8242L19.7238 19.7317" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="stroke:#000;"></path><path class="closePopup" alt="'+getId+tType+d+'" d="M10.8164 19.7324L19.7238 10.825" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="stroke:#000;"></path></svg></div>'+newEle;
                                                    // if(newEle)
                                                    // popOutEle1.innerHTML = newEle;
                                                    if(document.getElementById('dotType'+getId+tType+d))
                                                    var topStyle = parseFloat(document.getElementById('dotType'+getId+tType+d).style.top)+parseFloat(document.getElementById('dotType'+getId+tType+d).style.height);
                                                    else
                                                    var topStyle = parseFloat(yCoordinate-4)+parseFloat(dotHeight);
                                                    //var topStyle = parseFloat(document.getElementById('dotType'+getId+tType).style.top)+parseFloat(document.getElementById('dotType'+getId+tType).style.height);
                                                    popOutEle1.style.top = parseFloat(topStyle-4)+'px';
                                                    //var leftStyle = parseFloat(document.getElementById('dotType'+getId+tType).style.left)+parseFloat(document.getElementById('dotType'+getId+tType).style.width);
                                                    if(document.getElementById('dotType'+getId+tType+d))
                                                    var leftStyle = parseFloat(document.getElementById('dotType'+getId+tType+d).style.left)+parseFloat(document.getElementById('dotType'+getId+tType+d).style.width);
                                                    else
                                                    var leftStyle = parseFloat(xCoordinate-4)+parseFloat(dotWidth);
                                                    popOutEle1.style.left = parseFloat(leftStyle)+'px';
                                                    popOutEle1.style.maxWidth = blockWidth+'px';
                                                    popOutEle1.style.minHeight = blockHeight+'px';
                                                    popOutEle1.style.height = 'auto';
                                                    //popOutEle1.style.zIndex = 99;
                                                    if(enableFlash === false){
                                                        popOutEle1.style.transform = 'none';
                                                    }
                                                    //add currencgy symbol to price
                                                    //getCartupRefactoredprice(data[index]["price"], currencyPattern);
                                                    if(popOutEle1.getElementsByClassName('flyout-price').length > 0){
                                                        if(!spotdyEventsConfigData.currentPattern){
                                                            var currencyPattern = {
                                                                "currency": "dollar",
                                                                "seperator": ".",
                                                                "toFixed": "2"
                                                            };
                                                        }else{
                                                            var currencyPattern = JSON.parse(spotdyEventsConfigData.currentPattern);
                                                        }

                                                        var priceDiv = popOutEle1.getElementsByClassName('flyout-price')[0].getElementsByTagName('span');

                                                        for(var pd=0;pd<priceDiv.length;pd++){
                                                            var getCurrencyPrice = getCartupRefactoredprice(parseFloat(priceDiv[pd].innerText), currencyPattern);
                                                            popOutEle1.getElementsByClassName('flyout-price')[0].getElementsByTagName('span')[pd].innerText = getCurrencyPrice;
                                                        }
                                                    }

                                                    //manage left position according to media screen
                                                    if(window.screen.width > 750){
                                                        var totalWidth = parseFloat(popOutEle1.clientWidth+parseFloat(popOutEle1.style.left));
                                                        if(totalWidth>window.screen.width){
                                                        var calcLeft = totalWidth - window.screen.width;
                                                            calcLeft = parseFloat(popOutEle1.style.left) - parseFloat(calcLeft);
                                                            popOutEle1.style.left = parseFloat(calcLeft)+parseFloat(5)+'px';
                                                            popOutEle1.style.marginTop = 5+'px';
                                                            popOutEle1.style.top = parseFloat(popOutEle1.style.top)+parseFloat(10)+'px';
                                                        }
                                                        var totalHeight = parseFloat(popOutEle1.clientHeight)+parseFloat(popOutEle1.style.top);
                                                        if(target)
                                                        if(totalHeight>target.clientHeight){
                                                            var calcTop = totalHeight - target.clientHeight;
                                                            calcTop = parseFloat(popOutEle1.style.top) - parseFloat(calcTop);
                                                            if(calcTop-dotHeight > 0)
                                                            popOutEle1.style.top = parseFloat(calcTop-dotHeight)+'px';
                                                        }
                                                    }
                                            }
                                        }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }

        }
    }

}).then((responseJson) => {
    if(element)
    sortdiv(element)
})
}
function adjustTextColor(dotColor) {
                                            
                                            
        // Get the element's background color
        var bgColor = dotColor
        var newColor = '#000';
        // Call lightOrDark function to get the brightness (light or dark)
        var brightness = lightOrDark(bgColor);
        
        // If the background color is dark, add the light-text class to it
        if(brightness == 'dark') {
            newColor = '#fff'
        }
        else {
            newColor = '#000'
        }
        return newColor;
    }

    function lightOrDark(color) {

    // Check the format of the color, HEX or RGB?
    if (color.match(/^rgb/)) {

        // If HEX --> store the red, green, blue values in separate variables
        color = color.match(/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+(?:\.\d+)?))?\)$/);

        var r = color[1];
        var g = color[2];
        var b = color[3];
    } 
    else {

        // If RGB --> Convert it to HEX: http://gist.github.com/983661
        color = +("0x" + color.slice(1).replace( 
        color.length < 5 && /./g, '$&$&'
        )
                );

        var r = color >> 16;
        var g = color >> 8 & 255;
        var b = color & 255;
    }

    // HSP (Highly Sensitive Poo) equation from http://alienryderflex.com/hsp.html
    var hsp = Math.sqrt(
        0.299 * (r * r) +
        0.587 * (g * g) +
        0.114 * (b * b)
    );

    // Using the HSP value, determine whether the color is light or dark
    if (hsp>127.5) {

        return 'light';
    } 
    else {

        return 'dark';
    }
    }


function videoHandler(e) {
	e.preventDefault();
	videotarget = this.getAttribute("href");
	filename = videotarget.substr(0, videotarget.lastIndexOf('.')) || videotarget;
	video = document.querySelector("#video_player video");
	video.removeAttribute("controls");
	video.removeAttribute("poster");
	source = document.querySelectorAll("#video_player video source");
	source[0].src = filename + ".mp4";
	source[1].src = filename + ".webm";
	video.load();
	video.play();    
}
function fetchRecomInDots(element,widgetId,width,height){
    setTimeout(() => {
        if(!element)
        return;
        var popOutEle = document.createElement('div');
        popOutEle.setAttribute('class','popOverDiv popOverDivRecom');
    
        element.appendChild(popOutEle);
        popOutEle.setAttribute('id','dotType_Recommendation');
        //setTimeout(function(){
            if(document.getElementById(widgetId)){
                if(document.getElementById(widgetId).innerHTML.length>0){
                    popOutEle.innerHTML = '<div class="closeDots" alt="'+type+'">x</div>'+document.getElementById(widgetId).innerHTML;
                    popOutEle.style.top = parseFloat(document.getElementById('dotTypeRecommendation').style.top) +parseFloat(document.getElementById('dotTypeRecommendation').style.height)+'px';
                    popOutEle.style.left = parseFloat(document.getElementById('dotTypeRecommendation').style.left) +parseFloat(document.getElementById('dotTypeRecommendation').style.width)+'px';
                    popOutEle.style.maxWidth = width+'px';
                    popOutEle.style.minHeight = height+'px';
                    if(enableFlash === false){
                        popOutEle1.style.transform = 'none';
                    }
                }
            }
    }, (1000));
}

function insertDotsBasedOnPosition(target, badgingElement, position) {
    if(position == "Prev element") {
        target.parentNode.insertBefore(badgingElement, target);
    } else if(position == "First element") {
        target.prepend(badgingElement );
    } else if(position == "Next element") {
        target.parentNode.insertBefore(badgingElement, target.nextSibling);
    } else {
        target.appendChild(badgingElement);
    }
}

function sortdiv(element){
    var divs = element.getElementsByClassName('dotTypeIcon');
    var a = [];
    for (var i=0, iLen=divs.length; i<iLen; i++) { 
        a[i] = divs[i];
    }
    a.sort(function(a, b) {
        return a.getAttribute('data-order') < b.getAttribute('data-order')? -1 : a.getAttribute('data-order') == b.getAttribute('data-order')? 0 : 1;
    });
    while (iLen--) {
        element.insertBefore(a[iLen], element.firstChild);
    }
}

